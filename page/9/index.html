<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="越努力越幸运">
<meta property="og:type" content="website">
<meta property="og:title" content="默默">
<meta property="og:url" content="https://yangjinheng.github.io/page/9/index.html">
<meta property="og:site_name" content="默默">
<meta property="og:description" content="越努力越幸运">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="默默">
<meta name="twitter:description" content="越努力越幸运">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yangjinheng.github.io/page/9/">





  <title>默默</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?be46574a10a6c2b7f67e9c32a008cbd5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">默默</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-前端知识">
          <a href="/categories/web/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-asterisk"></i> <br>
            
            前端知识
          </a>
        </li>
      
        
        <li class="menu-item menu-item-kubernetes">
          <a href="/categories/Kubernetes/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cog"></i> <br>
            
            Kubernetes
          </a>
        </li>
      
        
        <li class="menu-item menu-item-运维笔记">
          <a href="/categories/运维笔记/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            运维笔记
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/Python/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-laptop"></i> <br>
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-golang">
          <a href="/categories/golang/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            Golang
          </a>
        </li>
      
        
        <li class="menu-item menu-item-个人日志">
          <a href="/categories/个人日志/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-github-alt"></i> <br>
            
            个人日志
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            给我留言
          </a>
        </li>
      

      
    </ul>
  

  
</nav>


 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yangjinheng.github.io/2019/03/29/kubernetes/kubernetes简介安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jin Heng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="默默">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/29/kubernetes/kubernetes简介安装/" itemprop="url">Kubernetes入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-29T00:00:00+08:00">
                2019-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Kubernetes简介"><a href="#Kubernetes简介" class="headerlink" title="Kubernetes简介"></a>Kubernetes简介</h1><ul>
<li>学习资料来源</li>
</ul>
<p>马哥教育：<a href="https://blog.51cto.com/mageedu" target="_blank" rel="noopener">https://blog.51cto.com/mageedu</a></p>
<p>马哥Github：<a href="https://github.com/iKubernetes" target="_blank" rel="noopener">https://github.com/iKubernetes</a></p>
<p>阳明的博客（K8S讲师）：<a href="https://www.qikqiak.com/page/archive/" target="_blank" rel="noopener">https://www.qikqiak.com/page/archive/</a></p>
<p>宋净超（云原生架构手册）：<a href="https://jimmysong.io/kubernetes-handbook/" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/</a></p>
<p>Helm 用户指南：<a href="https://whmzsu.github.io/helm-doc-zh-cn/" target="_blank" rel="noopener">https://whmzsu.github.io/helm-doc-zh-cn/</a></p>
<p>运维之美：<a href="https://www.hi-linux.com/archive/" target="_blank" rel="noopener">https://www.hi-linux.com/archive/</a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>kubernetes 是希腊语，翻译过来是：舵手的意思，它的原型是谷歌内部使用 Borg 集群管理系统，可以说是集结了 Borg 设计思想的精华，并且吸收了 Borg 系统中的经验和教训。</p>
<p>它的目标不仅仅是一个编排系统，而是提供一个规范，可以让你来描述集群的架构，定义服务的最终状态，Kubernetes可以帮你将系统自动地达到和维持在这个状态。Kubernetes作为云原生应用的基石，相当于一个云操作系统，其重要性不言而喻。</p>
<p>kubernetes 在 2014 年发布了第一个版本，目前开源并托管在 Github 上。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/Kubernetes</span><br></pre></td></tr></table></figure>
<p>目前，AWS、阿里云、微软云，目前已经原生支持 K8S ，目前已经可以让用户直接部署云原生的服务。</p>
<ul>
<li>有什么优势，为什么值得学</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 基于 Borg 系统，设计成熟，开源、且轻量级，简单易学、容易理解；</span><br><span class="line">- 模块化，可插拔，支持钩子，可任意组合，例如：网络组件 flannel，存储插件；</span><br><span class="line">- 故障发现（存活性探针）和自我修复能力（副本数量）、服务滚动升级（就绪探针）和在线扩容（副本数量）；</span><br><span class="line">- 可扩展的资源自动调度机制（多维度的水平自动扩容）、多粒度的资源配额管理能力（资源限制）。</span><br></pre></td></tr></table></figure>
<h2 id="Master包含组件"><a href="#Master包含组件" class="headerlink" title="Master包含组件"></a>Master包含组件</h2><p>Master 组件提供的集群控制，Master 组件对集群做出全局性决策(例如：调度)等，负责维护集群的目标状态。</p>
<ul>
<li>etcd</li>
</ul>
<p>用于 Kubernetes 的后端数据存储，所有集群数据都存储在此处</p>
<ul>
<li>kube-apiserver</li>
</ul>
<p>对外暴露了 Kubernetes API，它是的 Kubernetes 前端控制层，只有 API Server 会与 etcd 通信，其它模块都必须通过 API Server 访问集群状态。</p>
<ul>
<li>kube-controller-manager</li>
</ul>
<p>处理集群中常规任务，它是单独的进程，内部包含多个控制器，包含如下控制器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 节点控制器: 当节点移除时，负责注意和响应。</span><br><span class="line">- 副本控制器: 负责维护系统中每个副本控制器对象正确数量的 Pod。</span><br><span class="line">- 端点控制器: 填充 端点(Endpoints) 对象(即连接 Services &amp; Pods)。</span><br><span class="line">- 服务帐户和令牌控制器: 为新的命名空间创建默认帐户和 API 访问令牌</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-scheduler</li>
</ul>
<p>监视新创建的 Pod 为新创建的 POD 分配合适的 node 节点</p>
<ul>
<li>addons（插件）</li>
</ul>
<p>插件是实现集群功能的 Pod 和 Service，一般被创建于 kube-system 命名空间。例如：coreDNS</p>
<p>虽然其他插件并不是必需的，但所有 Kubernetes 集群都应该具有Cluster DNS，许多应用依赖于它，为 Kubernetes 服务提供 DNS 记录，容器启动该后会自动将 DNS 服务器包含在自己的 /etc/resolv.conf 中。</p>
<h2 id="Nodes包含组件"><a href="#Nodes包含组件" class="headerlink" title="Nodes包含组件"></a>Nodes包含组件</h2><p>Node 节点实际负责实施，也就是运行 POD 的节点，上面运行的组件有</p>
<ul>
<li>kubelet</li>
</ul>
<p>它监测已经分配给自己的 Pod，为 POD 准备卷，下载 POD 所需的 Secret，下载镜像并运行，进行生命周期探测，上报 POD 和节点状态</p>
<ul>
<li>kube-proxy</li>
</ul>
<p>通过维护主机上的网络规则并执行连接转发，将 Kubernetes 提供的网络服务代理到每个节点上，实现了Kubernetes服务抽象</p>
<ul>
<li>docker</li>
</ul>
<p>用于运行容器</p>
<h1 id="组件和附件"><a href="#组件和附件" class="headerlink" title="组件和附件"></a>组件和附件</h1><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><p>这些控制器分别用于确保不同类型的 POD 资源运行于符合用户所期望的状态。</p>
<ul>
<li>RelicationController</li>
</ul>
<p>控制同一类 POD 对象的副本数量，实现程序的滚动更新，或者回滚的操作。</p>
<p>在滚动更新时候，允许临时超出规定的副本数量，</p>
<ul>
<li>RelicaSet</li>
</ul>
<p>副本集控制器，它不直接使用，它有一个声明式中心控制器 Deployment</p>
<ul>
<li>Deployment</li>
</ul>
<p>它只能管理无状态的应用，这个控制器，支持二级控制器，例如：HPA（Horizontal Pod Autoscaler，水平 POD 自动伸缩控制器），当负载高的时候，自动启动更多的 POD。</p>
<ul>
<li>StatefulSet</li>
</ul>
<p>管理有状态的应用</p>
<ul>
<li>DaeminSet</li>
</ul>
<p>如果需要在每一个 node 上运行一个副本，而不是随意运行</p>
<ul>
<li>Job</li>
</ul>
<p>运行作业，时间不固定的操作，例如：备份、清理，临时启动一个 POD 来进行备份的任务，运行完成就结束了。</p>
<p>如果运行时候 JOB 挂了，那么需要重新启动起来，如果运行完成了则不需要再启动了。</p>
<ul>
<li>Cronjob</li>
</ul>
<p>和周期性作业</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>为客户端提供一个稳定的访问入口，Service 靠标签选择器来关联 POD 的，只要 POD 上有相关的标签，那么就会被 Service 选中，作为 Service 的后端，Service 关联 POD 后会动态探测这个 POD 的 IP 地址和端口，并作为自己调度的后端。</p>
<p>总的来说客户端请求 Service 由 Service 代理至后端的 POD，所以客户端看到的始终是 Service 的地址。</p>
<p>K8S 上的 Service 不是一个应用程序，也不是一个组件，它是一个 iptables dnat 规则，或者 ipvs 规则，Service 只是规则，所以是 ping 不通的，但是它的确可以请求。</p>
<p>Service 作为 k8s 的对象来说，是有名称的，可以通过 Service 的名称解析为 Service 的 IP 地址。</p>
<ul>
<li>AddOns</li>
</ul>
<p>解析域名是由 DNS 来解析的，为 k8s 中提供域名解析这种基础服务，称之为基础架构 POD 也称为 k8s 附件，所以域名解析的 POD 就是 k8s 中的一种 AddOns。</p>
<p>而 k8s 中的 dns 附件，是动态的，例如：service 名称发生更改，就会自动触发 dns 中的解析记录的改变，如果手动修改 service 的地址，也会自动触发 DNS 解析记录的改变，所以客户端访问服务时，可以直接访问服务的名称。</p>
<h2 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h2><p>k8s 有三种网络：POD网络、集群网络、节点网络</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POD网络：所有 POD 处于同一个网络中</span><br><span class="line">集群网络：Service 是一个另外一个网络</span><br><span class="line">节点网络：node 节点也是另外一个网络</span><br></pre></td></tr></table></figure>
<p>所以，接入外部访问时候，请求首先到达 node 网络，然后 node 网络代理至 service 网络，service 根据 ipvs 规则来转发到 pod 网络中的 pod 上。</p>
<p>k8s 有三种通信：</p>
<p>同一个 POD 内的多个容器间的通信，可以直接通过 lo 通信</p>
<p>POD 与 POD 通信，所有 POD 都处于一个网络，可以跨 node 与另外的 POD 直接通信，因为使用了叠加网络。</p>
<p>POD 与 Service 通信，</p>
<h2 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h2><p>在 node 节点上运行的一个守护进程，它负责随时与 apiserver 进行通信，因为每个 pod 发生变化后需要保存在 apiserver 中，而 apiserver 发生改变后会生成一个通知事件，这个事件可以被任何关联的组件接收到，例如被 kube-proxy 一旦发现某个 service 后端的 pod 地址发生改变，那么就由 kube-proxy 负责在本地将地址写入 iptables 或者 ipvs 规则中。</p>
<p>所以 service 的管理是靠 kube-proxy 来实现的，当你创建一个 service ，那么就靠 kube-proxy 在每个节点上创建为 iptables 或者 ipvs 规则，每个 service 的变动也需要 kube-proxy 反应到规则上。</p>
<p>apiserver 需要保存各个 node 信息，它需要保存在 etcd 中。</p>
<h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><p>是一个键值存储的系统，与 redis 很想，但是 etcd 还有一些协调功能是 redis 所不具备的，它还有节点选举等功能，从这个角度来讲 etcd 更像 zookpeer。</p>
<p>由于整个集群的所有信息都保存在 etcd，所以 etcd 如果宕机，那么整个集群就挂了，因而 etcd 需要做高可用。</p>
<h2 id="flanel"><a href="#flanel" class="headerlink" title="flanel"></a>flanel</h2><p>托管为 k8s 的附件运行</p>
<p>node 网络：各节点之间进行通信</p>
<p>POD 网络：所有 node上的 POD 彼此之间通过叠加，或者直接路由方式通信</p>
<p>service 网络：由 kube-proxy 负责管控和生成</p>
<h1 id="入门命令"><a href="#入门命令" class="headerlink" title="入门命令"></a>入门命令</h1><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><p>kubectl 是 apiserver 的客户端程序，这个客户端程序是通过连接 master 节点上的 apiserver ，实现各种 k8s 对象的增删改查等基本操作，在 k8s 可被管理的对象有很多个</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">基本命令 (初级):</span><br><span class="line">  create         从文件或标准输入创建资源</span><br><span class="line">  expose         获取一个复制控制器，服务，部署或者暴露一个 POD 将其作为新的 Kubernetes 服务公开</span><br><span class="line">  run            创建并运行特定的镜像，创建使用 deployment 或 job 管理的容器</span><br><span class="line">  <span class="built_in">set</span>            设置对象的特定功能</span><br><span class="line"></span><br><span class="line">基本命令 (中级):</span><br><span class="line">  explain        文档或者资源</span><br><span class="line">  get            显示一个或多个资源</span><br><span class="line">  edit           编辑服务器上的资源</span><br><span class="line">  delete         按文件名，标准输入，资源和名称或资源和标签选择器删除资源</span><br><span class="line"></span><br><span class="line">部署命令:</span><br><span class="line">  rollout        管理资源的部署</span><br><span class="line">  scale          为部署设置新大小，ReplicaSet, Replication Controller, Job</span><br><span class="line">  autoscale      自动扩展一个部署, ReplicaSet, 或者 ReplicationController</span><br><span class="line"></span><br><span class="line">群集管理命令:</span><br><span class="line">  certificate    修改证书资源.</span><br><span class="line">  cluster-info   显示群集信息</span><br><span class="line">  top            显示资源（CPU /内存/存储）使用情况。</span><br><span class="line">  cordon         将节点标记为不可调度</span><br><span class="line">  uncordon       将节点标记为可调度</span><br><span class="line">  drain          设定 node 进入维护模式</span><br><span class="line">  taint          更新一个或多个节点上的污点</span><br><span class="line"></span><br><span class="line">故障排除和调试命令:</span><br><span class="line">  describe       显示特定资源或资源组的详细信息</span><br><span class="line">  logs           在容器中打印容器的日志</span><br><span class="line">  attach         附加到正在运行的容器</span><br><span class="line">  <span class="built_in">exec</span>           在容器中执行命令</span><br><span class="line">  port-forward   将一个或多个本地端口转发到 pod</span><br><span class="line">  proxy          运行代理到 Kubernetes API 服务器</span><br><span class="line">  cp             将文件和目录复制到容器，和从容器复制，跨容器复制文件</span><br><span class="line">  auth           检查授权</span><br><span class="line"></span><br><span class="line">高级命令:</span><br><span class="line">  diff           针对将要应用的版本的 Diff 实时版本</span><br><span class="line">  apply          通过文件名或标准输入将配置应用于资源</span><br><span class="line">  patch          使用策略合并补丁更新资源的字段</span><br><span class="line">  replace        用文件名或标准输入替换资源</span><br><span class="line">  <span class="built_in">wait</span>           实验阶段命令：在一个或多个资源上等待特定条件，定义一个触发器</span><br><span class="line">  convert        在不同的API版本之间转换配置文件</span><br><span class="line">  kustomize      从目录或远程 URL 构建 kustomization 目标</span><br><span class="line"></span><br><span class="line">设置命令:</span><br><span class="line">  label          更新资源上的标签</span><br><span class="line">  annotate       更新资源上的注释</span><br><span class="line">  completion     命令补全相关功能</span><br><span class="line"></span><br><span class="line">其他命令:</span><br><span class="line">  api-resources  在服务器上打印支持的API资源</span><br><span class="line">  api-versions   以 <span class="string">"group/version"</span> 的形式在服务器上打印支持的API版本</span><br><span class="line">  config         修改 kubeconfig 文件</span><br><span class="line">  plugin         提供与插件交互的实用程序</span><br><span class="line">  version        打印客户端和服务器版本信息</span><br></pre></td></tr></table></figure>
<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><ul>
<li>创建控制器并运行镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run nginx --image=nginx:latest    <span class="comment"># 创建一个名为 nginx 的控制器，运行 nginx:latest 版本的镜像</span></span><br></pre></td></tr></table></figure>
<ul>
<li>指定运行的 POD 数量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run nginx --image=nginx --replicas=5  <span class="comment"># 启动 5 个 POD</span></span><br></pre></td></tr></table></figure>
<ul>
<li>不运行容器的默认命令，使用自定义的指令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run nginx --image=nginx --<span class="built_in">command</span> -- &lt;cmd&gt; &lt;arg1&gt; ... &lt;argN&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>运行一个周期任务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run pi --schedule=<span class="string">"0/5 * * * ?"</span> --image=perl --restart=OnFailure -- perl -Mbignum=bpi -wle <span class="string">'print bpi(2000)'</span></span><br></pre></td></tr></table></figure>
<h2 id="run示例"><a href="#run示例" class="headerlink" title="run示例"></a>run示例</h2><ul>
<li>指定控制器名称运行 nginx 指定端口和副本数量，以测试模式运行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run nginx-deploy --image=nginx --port=80 --replicas=1 --dry-run=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看容器是否运行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get deployment</span><br></pre></td></tr></table></figure>
<ul>
<li>查看被调度的主机</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 ip 地址直接访问，由于所有的 POD 处于同一个网络中，所以在集群内部是可以访问的</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl 10.244.2.2</span><br></pre></td></tr></table></figure>
<ul>
<li>假如现在删除刚创建的这个 POD，那么副本控制器会自动在其他的 node 上重建这个 POD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl delete pods nginx-deploy-5c9b546997-jsmk6</span><br></pre></td></tr></table></figure>
<ul>
<li>再次执行查看，会发现容器已经被调度到其他节点上运行了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>
<h2 id="expose"><a href="#expose" class="headerlink" title="expose"></a>expose</h2><p>现在存在一个问题，就是 POD 的 IP 地址可能随时发生变动，所以不能作为访问的入口，那么就需要 service 来代理 POD 来创建一个固定的端点。</p>
<ul>
<li>创建一个 service 暴露一个服务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl expose deployment nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">在控制器 nginx-deploy 上创建名字为 nginx 的 service ，它工作端口为 80，代理的后端容器端口 80，协议为 TCP。</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到刚刚创建的名字为 nginx 的 service ，现在就可以在集群内用 service 的地址来访问了，外部不行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>
<ul>
<li>删除一个任务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl delete deployment nginx-deploy</span><br></pre></td></tr></table></figure>
<h2 id="coredns"><a href="#coredns" class="headerlink" title="coredns"></a>coredns</h2><p>service 提供了对 pod 的固定访问端点，但是 service 本身的变动我们无法知晓，需要 coredns 对 service 做域名解析。</p>
<ul>
<li>查看 coredns 运行状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>
<ul>
<li>查看各个 kube-system 命名空间运行的服务，可以看到 kube-dns 运行的 IP 地址</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get service -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 kube-dns 来解析 nginx 这个 service 的地址就可以正常解析了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig -t A nginx.default.svc.cluster.local @10.96.0.10</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个访问 nginx 客户端容器，并进入交互式模式，这个容器默认的 dns 服务器就是 kube-dns 所在的服务器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run client --image=busybox --replicas=1 -it --restart=Never</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line">nameserver 10.96.0.10                                               <span class="comment"># kube-dns 地址</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local    <span class="comment"># 默认的解析搜索域</span></span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>
<ul>
<li>在 busybox 这个容器中请求 nginx 这个域名的 service ，能够正常访问</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -O - -q http://nginx:80/</span><br></pre></td></tr></table></figure>
<h3 id="模拟-POD-被删除"><a href="#模拟-POD-被删除" class="headerlink" title="模拟 POD 被删除"></a>模拟 POD 被删除</h3><ul>
<li>现在我们删除 service 后端的 POD ，副本控制器会自动创建新的 POD，而 service 则会自动指向新创建的 POD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl delete pods nginx-deploy-5c9b546997-4w24n</span><br></pre></td></tr></table></figure>
<ul>
<li>查看由副本控制器自动创建的 POD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>
<ul>
<li>在 busybox 这个容器中请求 nginx 这个域名的 service ，访问没有受到影响</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -O - -q http://nginx:80/</span><br></pre></td></tr></table></figure>
<h3 id="模拟-service-被删除"><a href="#模拟-service-被删除" class="headerlink" title="模拟 service 被删除"></a>模拟 service 被删除</h3><ul>
<li>当我们删除 service 并且重新建立一个 service 再次查看 service 的地址已经发生变化了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl delete service nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl expose deployment nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>
<ul>
<li>在 busybox 这个容器中请求 nginx 这个域名的 service ，访问没有仍然没有受到影响</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -O - -q http://nginx:80/</span><br></pre></td></tr></table></figure>
<h2 id="labels"><a href="#labels" class="headerlink" title="labels"></a>labels</h2><p>为什么 Pod 被删除后，servic 仍然能够正确的调度到新的 POD 上，这就是 k8s 的 labels 这个机制来保证的。</p>
<p>能够使用标签机制不止有 pod、在 k8s 中很多对象都可以使用标签，例如：node、service</p>
<ul>
<li>查看 service 的详细信息，会发现标签选择器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe service nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Name:              nginx</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            run=nginx-deploy</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          run=nginx-deploy       <span class="comment"># 这个选择器会自动选中 run 标签，且值为 nginx-deploy 的 POD</span></span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.101.149.4</span><br><span class="line">Port:              &lt;<span class="built_in">unset</span>&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.244.2.4:80          <span class="comment"># 当 service 的后端，当 POD 发生变动则立即会更新</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 POD 的标签，会看到拥有 run=nginx-deploy 标签的容器，而人为删除一个 POD 后，副本控制器创建的副本上的标签不会变化，所以标签又被 service 关联。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods --show-labels</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">client                          1/1     Running   0          21m     run=client</span><br><span class="line">nginx-deploy-5c9b546997-kh88w   1/1     Running   0          8m37s   pod-template-hash=5c9b546997,run=nginx-deploy</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 POD 的详细信息，也可以查看到 POD 的详细信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe deployment nginx-deploy</span><br></pre></td></tr></table></figure>
<ul>
<li>根据标签过滤，使用 -l 来指定标签名称或同时过滤其值</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods --show-labels -l run=nginx-deploy</span><br></pre></td></tr></table></figure>
<ul>
<li>标签选择器集中运算</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">关系与：KEY,KEY、KEY=VALUE2,KEY=VALUE2       <span class="comment"># -l run,app</span></span><br><span class="line">等值关系：KEY = VALUE、KEY != VALUE           <span class="comment"># -l run=nginx-deploy,app!=myapp</span></span><br><span class="line">集合关系：KYE <span class="keyword">in</span>|not <span class="keyword">in</span> (VALUE1,VALUE2)      <span class="comment"># -l "release in (canary,bata,alpha)"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>显示指定的标签的值，下面显示了两个标签</li>
</ul>
<p>​<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods --show-labels -L run,pod-template-hash</span><br></pre></td></tr></table></figure></p>
<ul>
<li>为指定的 POD 打标签，为 client 这个 POD 打上一个 release 标签，其值为 canary</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label pods client release=canary</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 POD 的标签，使用 –overwrite 进行修改原有标签</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label pods client release=stable --overwrite</span><br></pre></td></tr></table></figure>
<ul>
<li>删除指定的 nodes 上的标签，使用标签名称加 - 符号</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label nodes node2 disktype-</span><br></pre></td></tr></table></figure>
<ul>
<li>许多资源支持内嵌字段来定义其使用的标签选择器，例如 service 关联 pod 时候：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">matchLabels：直接给定键值</span><br><span class="line">matchExpressions：基于给定的表达式来定义使用标签选择器：&#123;key:<span class="string">"KEY"</span>,operator:<span class="string">"OPERATOR"</span>,value:[VAL1,VAL2,...]&#125;</span><br><span class="line">    使用 key 与 value 进行 operator 运算，复合条件的才被选择</span><br><span class="line">    操作符：</span><br><span class="line">    	In、NotIn：其 value 列表必须有值</span><br><span class="line">    	Exists、NotExists：其 value 必须为空</span><br></pre></td></tr></table></figure>
<ul>
<li>k8s 中很多对象都可以打标签，例如给 nodes 打一个标记，随后在添加资源时候就可以让资源对节点有倾向性了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label nodes node2 disktype=ssd</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes --show-labels</span><br></pre></td></tr></table></figure>
<h2 id="动态扩容"><a href="#动态扩容" class="headerlink" title="动态扩容"></a>动态扩容</h2><ul>
<li>扩容一个集群的的 POD，下面命令表示修改 deployment 控制器下的 nginx-deply 容器的副本数量为2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl scale --replicas=5 deployment nginx-deploy</span><br></pre></td></tr></table></figure>
<h2 id="滚动升级"><a href="#滚动升级" class="headerlink" title="滚动升级"></a>滚动升级</h2><ul>
<li>更换 nginx-deploy 这个控制器下的 nginx-deploy 容器镜像为 ikubernetes/myapp:v2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment nginx-deploy nginx-deploy=ikubernetes/myapp:v2</span><br></pre></td></tr></table></figure>
<ul>
<li>查看更新的过程，直到 5 个容器中运行的镜像全部更新完毕</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment nginx-deploy</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># kubectl rollout status deployment nginx-deploy</span></span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 4 of 5 updated replicas are available...</span><br><span class="line">deployment <span class="string">"nginx-deploy"</span> successfully rolled out</span><br></pre></td></tr></table></figure>
<ul>
<li>回滚操作，不指定任何的镜像则为上一个版本的镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl rollout undo deployment nginx-deploy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  如果防止更新过程中被调度，那么就需要学习就绪性检测才能实现</p>
</blockquote>
<h2 id="集群外访问"><a href="#集群外访问" class="headerlink" title="集群外访问"></a>集群外访问</h2><ul>
<li>修改 service 的网络类型为 NodePort</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit service nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type</span>: ClusterIP -&gt; <span class="built_in">type</span>: NodePort</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 service 的信息，发现多了一个 30982 端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        15h</span><br><span class="line">nginx        NodePort    10.105.27.11   &lt;none&gt;        80:30982/TCP   42m</span><br></pre></td></tr></table></figure>
<ul>
<li>在集群外部使用任意的 node IP 地址 + 端口来访问</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://172.16.100.101:30982/</span><br></pre></td></tr></table></figure>
<h2 id="排查日志"><a href="#排查日志" class="headerlink" title="排查日志"></a>排查日志</h2><ul>
<li>查看一个 pod 的某个容器的运行日志</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl logs pod-demo busybox</span><br></pre></td></tr></table></figure>
<h2 id="连入-POD-容器"><a href="#连入-POD-容器" class="headerlink" title="连入 POD 容器"></a>连入 POD 容器</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it pod-demo -c myapp -- /bin/sh</span><br></pre></td></tr></table></figure>
<h2 id="在容器内执行命令"><a href="#在容器内执行命令" class="headerlink" title="在容器内执行命令"></a>在容器内执行命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> myapp-deploy-5fdb5f69f-mg9b6 top</span><br><span class="line">kubectl <span class="built_in">exec</span> myapp-deploy-5fdb5f69f-mg9b6 -- sh -c <span class="string">'TEST="this is a test" ; echo $TEST'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行复杂命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">commands=<span class="string">'</span></span><br><span class="line"><span class="string">export CORE_PEER_LOCALMSPID=Org1MSP</span></span><br><span class="line"><span class="string">export CORE_PEER_ADDRESS=peer0-org1:7051</span></span><br><span class="line"><span class="string">export CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp</span></span><br><span class="line"><span class="string">export CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/msp/tlscacerts/tlsca.org1.qloudchain.com-cert.pem</span></span><br><span class="line"><span class="string">peer channel join --blockpath resources/channel-artifacts/channel.block</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line">kubectl -n baas <span class="built_in">exec</span> cli-org1-6c5fdf6d97-nh4r4 -- bash -c <span class="string">"<span class="variable">$commands</span>"</span></span><br></pre></td></tr></table></figure>
<h2 id="查看一个POD的镜像"><a href="#查看一个POD的镜像" class="headerlink" title="查看一个POD的镜像"></a>查看一个POD的镜像</h2><ul>
<li>参考</li>
</ul>
<p><a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/list-all-running-container-images" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/tasks/access-application-cluster/list-all-running-container-images</a></p>
<ul>
<li>go模板</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods peer1st-orga-0 -o go-template --template=<span class="string">'&#123;&#123;range .spec.containers&#125;&#125;&#123;&#123;printf "%s\n" .image&#125;&#125;&#123;&#123;end&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>json方式</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods nfs-client-provisioner-75bd696897-hm7xf -o jsonpath=<span class="string">'&#123;range .spec.containers[*]&#125;&#123;.image&#125;&#123;"\n"&#125;&#123;end&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="查看一个节点污点"><a href="#查看一个节点污点" class="headerlink" title="查看一个节点污点"></a>查看一个节点污点</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes 172.16.100.101 -o jsonpath=<span class="string">'&#123;.spec.taints&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="过滤显示结果"><a href="#过滤显示结果" class="headerlink" title="过滤显示结果"></a>过滤显示结果</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods --field-selector status.phase=Running --show-labels --selector app=myapp</span><br></pre></td></tr></table></figure>
<h2 id="并非所有资源都在命名空间"><a href="#并非所有资源都在命名空间" class="headerlink" title="并非所有资源都在命名空间"></a>并非所有资源都在命名空间</h2><p>大多数 kubernetes 资源（例如 Pod、服务、副本控制器等）都位于某些命名空间中。 但是命名空间资源本身并不在命名空间中。</p>
<p>而且底层资源，例如<a href="https://v1-12.docs.kubernetes.io/docs/admin/node" target="_blank" rel="noopener">节点</a>和持久化卷不属于任何命名空间。</p>
<p>查看哪些 Kubernetes 资源在命名空间中，哪些不在命名空间中：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> In a namespace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl api-resources --namespaced=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Not <span class="keyword">in</span> a namespace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl api-resources --namespaced=<span class="literal">false</span></span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yangjinheng.github.io/2019/03/29/kubernetes/Kubernetes高级部分/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jin Heng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="默默">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/29/kubernetes/Kubernetes高级部分/" itemprop="url">Kubernetes高级部分</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-29T00:00:00+08:00">
                2019-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="用户认证系统"><a href="#用户认证系统" class="headerlink" title="用户认证系统"></a>用户认证系统</h1><p>apiserver 是所有请求访问的网关接口，请求过程中，认证用于实现身份识别，授权用于实现权限检查，实际上，我们使用命令行：kubectl apply -f ment.yaml，实际上是转换为 HTTP 协议向 apiserver 发起请求的，而认证是信息由 ~/.kube/config 这个文件提供的，这个文件记录了管理员权限的用户信息。</p>
<ul>
<li>k8s 的 API 是 RESTfull 风格的，所以资源是由路径标明的，在 k8s 中，资源只能属于两个地方：属于集群 或 属于名称空间。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">集群级别：namespace、pv</span><br><span class="line">名称空间：POD、deployment、daemonSet、 service、PCV</span><br></pre></td></tr></table></figure>
<p>例如：请求 delfault 名称空间下的 myapp-deploy 控制器，就是下面的写法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://172.16.100.100/apis/apps/v1/namespaces/default/deployments/myapp-deploy</span><br></pre></td></tr></table></figure>
<p>上面表示：<a href="http://172.16.100.100:6443" target="_blank" rel="noopener">http://172.16.100.100:6443</a> 集群的 apis 下的 apps 组的 v1 版本的 namespaces 下寻找 default 下的 myapp-deploy 控制器</p>
<h2 id="用户的类型"><a href="#用户的类型" class="headerlink" title="用户的类型"></a>用户的类型</h2><p>我们使用 kubectl 连接 k8s 集群进行控制，实际上是使用用户家目录下 .kube/config 这个文件中的用户连接到 apiserver 实现认证的，而有些 POD （如：CoreDNS）也需要获取集群的信息，它们也需要连接到 k8s 集群中，所以 k8s 中用户的类型有两种：</p>
<ol>
<li>人类使用的用户：useraccount，处于用户家目录 .kube/config 文件中，可使用 kubectl config –help 获取帮助创建</li>
<li>POD 使用的用户：serviceaccunt，是一种 k8s 对象，它可以使用 kubectl create serviceaccount –help 获取帮助创建</li>
</ol>
<h2 id="POD如何连接集群"><a href="#POD如何连接集群" class="headerlink" title="POD如何连接集群"></a>POD如何连接集群</h2><p>POD 需要使用 serviceaccount 连接并认证到集群，POD 之所以能够连接到集群是因为有一个内置的 service 将 POD 的请求代理至 apiserver 的地址了。</p>
<ul>
<li>名字为 kubernetes 的 servie 为 POD 连接到 apiserver 提供了通信</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe service kubernetes                            <span class="comment"># 集群内部的 POD 与 apiserver 通信使用的 service ，但是注意 apiserver 需要认证的</span></span><br><span class="line"></span><br><span class="line">Name:              kubernetes</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            component=apiserver</span><br><span class="line">                   provider=kubernetes</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.1                                     <span class="comment"># 集群内部访问 apiserver 的网关</span></span><br><span class="line">Port:              https  443/TCP</span><br><span class="line">TargetPort:        6443/TCP</span><br><span class="line">Endpoints:         172.16.100.101:6443                           <span class="comment"># apiserver 工作的地址</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="serviceaccount-对象"><a href="#serviceaccount-对象" class="headerlink" title="serviceaccount 对象"></a>serviceaccount 对象</h2><p>k8s 的认证有两种一种是：human user、一种是 serviceaccount，下面就是创建 serviceaccount 它是 POD 访问 apiserver 所用的一种对象，而 human user，即使 kubectl 命令行通过读取 config 中的用户而认证到 apiserver 的。</p>
<ul>
<li>创建一个 serviceaccount 对象，它会自动创建并关联一个 secret，这个 serviceaccount 可以到 apiserver 上进行认证，但是认证不代表有权限，所以需要授权</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create serviceaccount admin</span><br><span class="line">$ kubectl get secret</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 POD 使用指定的 serviceaccount 对象</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-serviceaccount-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>
<h3 id="在-POD-中使用-serviceaccount"><a href="#在-POD-中使用-serviceaccount" class="headerlink" title="在 POD 中使用 serviceaccount"></a>在 POD 中使用 serviceaccount</h3><ul>
<li>POD 连接 apiserver 时候，需要在清单中指定 serviceAccountName 这个字段，详见：kubectl explain pods.spec</li>
</ul>
<p>每个 POD 默认自带一个 volumes，这是一个 secret，这个存储卷保存着 default-token-bq2gn 用来访问 apiserver ，而这个 secret 权限仅仅能通过 api 访问当前 POD 自身的信息，如果想要一个 POD 拥有管理集群的权限，那么可以手动创建一个 secret 并通过 volumes 挂载到 POD 上。</p>
<p>serviceaccout 也属于标准的 k8s 对象，这个对象提供了账号信息，但是账号由没有权限需要 rbac 机制来决定。</p>
<h2 id="kubectl-配置文件"><a href="#kubectl-配置文件" class="headerlink" title="kubectl 配置文件"></a>kubectl 配置文件</h2><ul>
<li>kubectl 配置文件解析，详见：kubectl config view</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span>                                             <span class="comment"># 集群列表</span></span><br><span class="line"><span class="attr">- cluster:</span>                                            <span class="comment"># 列表中的一个集群对象</span></span><br><span class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">DATA+OMITTED</span>          <span class="comment"># 服务器认证方式</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr">https://172.16.100.101:6443</span>               <span class="comment"># 集群的 apiserver 地址</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span>                                    <span class="comment"># 集群名称</span></span><br><span class="line"><span class="attr">users:</span>                                                <span class="comment"># 用户列表</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">kubernetes-admin</span>                              <span class="comment"># 列表中的一个用户对象</span></span><br><span class="line"><span class="attr">  user:</span>                                               <span class="comment"># </span></span><br><span class="line"><span class="attr">    client-certificate-data:</span> <span class="string">REDACTED</span>                 <span class="comment"># 客户端证书</span></span><br><span class="line"><span class="attr">    client-key-data:</span> <span class="string">REDACTED</span>                         <span class="comment"># 客户端私钥</span></span><br><span class="line"><span class="attr">contexts:</span>                                             <span class="comment"># 上下文列表</span></span><br><span class="line"><span class="attr">- context:</span>                                            <span class="comment"># 列表中的一个上下文对象</span></span><br><span class="line"><span class="attr">    cluster:</span> <span class="string">kubernetes</span>                               <span class="comment"># 集群名称</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">kubernetes-admin</span>                            <span class="comment"># 用户名称</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes-admin@kubernetes</span>                   <span class="comment"># 上下文名称</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span>          <span class="comment"># 当前上下文</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>配置文件保存了：多个集群、多用户的配置，kubectl 可以使用不同的用户访问不同的集群。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">集群列表：集群对象列表</span><br><span class="line">用户列表：用户对象列表</span><br><span class="line">上下文：是描述集群与用户的关系列表。</span><br><span class="line">当前上下文：表示当前使用哪个用户访问哪个集群</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">自定义配置信息：详见：kubectl config  --<span class="built_in">help</span></span><br><span class="line">ca 和证书保存路径：/etc/kubernetes 保存了所有的 ca 和签发的证书信息。</span><br></pre></td></tr></table></figure>
<h2 id="添加证书用户到-config"><a href="#添加证书用户到-config" class="headerlink" title="添加证书用户到 config"></a>添加证书用户到 config</h2><p>k8s apiserver 认证方式有两种：ssl证书 和 token 认证，本次使用 ssl 证书创建用户</p>
<h3 id="创建SSL证书用户"><a href="#创建SSL证书用户" class="headerlink" title="创建SSL证书用户"></a>创建SSL证书用户</h3><ul>
<li>创建连接 apiserver 的用户证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建私钥</span></span><br><span class="line">(<span class="built_in">umask</span> 077; openssl genrsa -out jinheng.key 2048)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书签署请求，O 是组，CN 就是账号，这个账号被 k8s 用来识别身份，授权也需要授权这个账号</span></span><br><span class="line">openssl req -new -key jinheng.key -out jinheng.csr -subj <span class="string">"/CN=jinheng"</span></span><br><span class="line"><span class="comment">#penssl req -new -key jinheng.key -out jinheng.csr -subj "O=system:masters/CN=jinheng/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 CA 签署证书，并且在 1800 天内有效</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> jinheng.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out jinheng.crt -days 1800</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> jinheng.crt -text -noout</span><br></pre></td></tr></table></figure>
<h3 id="添加SSL证书用户到config"><a href="#添加SSL证书用户到config" class="headerlink" title="添加SSL证书用户到config"></a>添加SSL证书用户到config</h3><ul>
<li>将 jinheng 用户添加到 k8s 的 config 中，设置客户端证书为 jinheng.crt，设置客户端私钥为：jinheng.key，使用 –embed-certs=true 来隐藏这些机密信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials jinheng --client-certificate=./jinheng.crt --client-key=./jinheng.key --embed-certs=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="创建切换上下文"><a href="#创建切换上下文" class="headerlink" title="创建切换上下文"></a>创建切换上下文</h3><ul>
<li>创建上下文对象，授权 jinheng 用户访问名称为 kubernetes 的集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context jinheng@kubernetes --cluster=kubernetes --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>切换当前使用的上下文，到授权 jinheng 到 kubernetes 的上下文上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>由于这个用户没有授权，所以这个用户是无法 get 到信息的，可以再切换回来</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="创建新-config-文件"><a href="#创建新-config-文件" class="headerlink" title="创建新 config 文件"></a>创建新 config 文件</h2><p>使用 kubectl config set-cluster 创建一个新的 config 文件，想要设定这个新创建的 config 文件可以使用 –kubeconfig=/tmp/test.conf 指明。</p>
<ul>
<li>设置集群的连接的 ca 机构证书，–kubeconfig 可以指定 kubectl 使用的配置文件位置，默认为用户家目录 .kube 目录中的 config</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-cluster k8s-cluster --server=https://172.16.100.101:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=<span class="literal">true</span> --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>将 jinheng 用户添加到 k8s 的 config 中，设置客户端证书为 jinheng.crt，设置客户端私钥为：jinheng.key，使用 –embed-certs=true 来隐藏这些机密信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials jinheng --client-certificate=./jinheng.crt --client-key=./jinheng.key --embed-certs=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建上下文对象，授权 jinheng 用户访问名称为 kubernetes 的集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context def-ns-admin@k8s-cluster --cluster=k8s-cluster --user=def-ns-admin --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>切换当前使用的上下文，到授权 jinheng 到 kubernetes 的上下文上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context def-ns-admin@k8s-cluster --kubeconfig=/tmp/test.con</span><br></pre></td></tr></table></figure>
<h2 id="基于-token-认证"><a href="#基于-token-认证" class="headerlink" title="基于 token 认证"></a>基于 token 认证</h2><h3 id="创建-serviceaccount"><a href="#创建-serviceaccount" class="headerlink" title="创建 serviceaccount"></a>创建 serviceaccount</h3><ul>
<li>为 POD 创建一个 serviceaccount 对象，它是 POD 访问 apiserver 的凭证</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount dashborad-admin -n kube-system</span><br></pre></td></tr></table></figure>
<h3 id="绑定集群管理员角色"><a href="#绑定集群管理员角色" class="headerlink" title="绑定集群管理员角色"></a>绑定集群管理员角色</h3><ul>
<li>创建 clusterrolebinding 将用户绑定至 cluster-admin 集群管理员（最高权限）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding dashborad-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashborad-admin</span><br></pre></td></tr></table></figure>
<h3 id="通过-serviceaccount-得到-Token"><a href="#通过-serviceaccount-得到-Token" class="headerlink" title="通过 serviceaccount 得到 Token"></a>通过 serviceaccount 得到 Token</h3><ul>
<li>找到刚才创建的 serviceaccount 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>得到 serviceaccount 对象中的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret -n kube-system dashborad-admin-token-skz95</span><br></pre></td></tr></table></figure>
<h1 id="用户权限系统"><a href="#用户权限系统" class="headerlink" title="用户权限系统"></a>用户权限系统</h1><p>在 k8s 中的用户权限系统是使用 RBAC 模式的，RBAC 是 Role-Based AC 的缩写，全称：基于角色的访问控制。</p>
<p>我们可以让一个用户扮演一个角色，而这个角色拥有权限，而这个用户就拥有了这个权限，所以在 RBAC 中，用户授权就是授权某个角色。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">用户（user）：用户可以拥有某个角色。</span><br><span class="line"></span><br><span class="line">角色（role）：角色可以拥有某些许可。</span><br><span class="line">	1. 操作</span><br><span class="line">	2. 对象</span><br><span class="line"></span><br><span class="line">许可（permission）： 在一个对象上能施加的操作组合起来，称之为一个许可权限。</span><br></pre></td></tr></table></figure>
<ul>
<li>用户类型</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Human User：              <span class="comment"># 用户账号</span></span><br><span class="line">Pod Service Account：     <span class="comment"># 服务账号</span></span><br></pre></td></tr></table></figure>
<ul>
<li>角色类型</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- rule（角色）、rolebinding（角色绑定）</span><br><span class="line">- clausterrole（集群角色）、clusterrolebinding（集群角色绑定）</span><br></pre></td></tr></table></figure>
<ul>
<li>授权类型</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- 用户通过 rolebinding 去 <span class="built_in">bind</span> rule，rolebinding 只能是当前命名空间中</span><br><span class="line">- 通过 clusterrolebinding 去 <span class="built_in">bind</span> clausterrole，clusterrolebinding会在所有名称空间生效</span><br><span class="line">- 通过 rolebinding 去 <span class="built_in">bind</span> clausterrole，由于 rolebinding 只在当前名称空间，所以 clausterrole 权限被限制为当前名称空间</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 rolebinding 去 bind clausterrole 的好处</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">如果有很多名称空间、如果用 rolebinding 绑定 rule，那么则需要在每个名称空间都定义 role</span><br><span class="line">如果使用 rolebinding 绑定一个 clausterrole ，由于 clausterrole 拥有所有名称空间的权限，而 rolebinding  只能绑定当前名称空间，那么就省去为每个名称空间都新建一个 role 的过程了。</span><br></pre></td></tr></table></figure>
<h2 id="权限列表"><a href="#权限列表" class="headerlink" title="权限列表"></a>权限列表</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole admin -o yaml</span><br></pre></td></tr></table></figure>
<h2 id="创建-Role"><a href="#创建-Role" class="headerlink" title="创建 Role"></a>创建 Role</h2><ul>
<li>命令行定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create role pods-reader --verb=get,list,watch --resource=pods</span><br></pre></td></tr></table></figure>
<ul>
<li>使用清单方式定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pods-reder</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span>                           <span class="comment"># 对哪些 api 群组内的资源进行操作</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span>                           <span class="comment"># 对哪些资源授权</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span>                               <span class="comment"># 授权做哪些操作</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>
<h2 id="创建-rolebinding"><a href="#创建-rolebinding" class="headerlink" title="创建 rolebinding"></a>创建 rolebinding</h2><ul>
<li>使用 rolebinding 对象创建，用户与 role 的绑定</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding jinheng-read-pods --role=pods-reader --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>使用清单方式定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jinheng-read-pods</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pods-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jinheng</span></span><br></pre></td></tr></table></figure>
<ul>
<li>切换用户和环境上下文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用户是否拥有 get 权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>
<h2 id="创建-clusterrole"><a href="#创建-clusterrole" class="headerlink" title="创建 clusterrole"></a>创建 clusterrole</h2><ul>
<li>命令行定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrole cluster-reader --verb=get,list,watch --resource=pods</span><br></pre></td></tr></table></figure>
<ul>
<li>使用清单方式定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure>
<ul>
<li>系统内置有非常多的 clusterrole，详见：kubectl get clusterrole</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                                                                   AGE</span><br><span class="line">admin                                                                  5d16h</span><br><span class="line">cluster-admin                                                          5d16h</span><br><span class="line">cluster-reader                                                         4m32s</span><br><span class="line">edit                                                                   5d16h</span><br><span class="line">flannel                                                                5d6h</span><br><span class="line">system:aggregate-to-admin                                              5d16h</span><br><span class="line">system:aggregate-to-edit                                               5d16h</span><br><span class="line">system:aggregate-to-view                                               5d16h</span><br><span class="line">system:auth-delegator                                                  5d16h</span><br><span class="line">system:aws-cloud-provider                                              5d16h</span><br><span class="line">system:basic-user                                                      5d16h</span><br><span class="line">system:certificates.k8s.io:certificatesigningrequests:nodeclient       5d16h</span><br><span class="line">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   5d16h</span><br><span class="line">system:controller:attachdetach-controller                              5d16h</span><br><span class="line">system:controller:certificate-controller                               5d16h</span><br><span class="line">system:controller:clusterrole-aggregation-controller                   5d16h</span><br><span class="line">system:controller:cronjob-controller                                   5d16h</span><br><span class="line">system:controller:daemon-set-controller                                5d16h</span><br></pre></td></tr></table></figure>
<h2 id="创建-clusterrolebinding"><a href="#创建-clusterrolebinding" class="headerlink" title="创建 clusterrolebinding"></a>创建 clusterrolebinding</h2><ul>
<li>命令行定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding jinheng-read-all-pods --clusterrole=cluster-reader --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>清单定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jinheng-read-all-pods</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jinheng</span></span><br></pre></td></tr></table></figure>
<ul>
<li>切换用户和环境上下文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用户是否拥有 get 权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="rolebinding-与-clusterrole"><a href="#rolebinding-与-clusterrole" class="headerlink" title="rolebinding 与 clusterrole"></a>rolebinding 与 clusterrole</h2><p>如果使用 rolebinding 绑定一个 clausterrole ，由于 clausterrole 拥有所有名称空间的权限，而 rolebinding  只能绑定当前名称空间，那么就省去为每个名称空间都新建一个 role 的过程了。</p>
<ul>
<li>命令定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create rolebinding jinheng-cluster-reader --clusterrole=cluster-reader --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>清单定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jinheng-admin</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>切换用户和环境上下文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用户是否拥有 get 权限，由于使用了 rolebinding ，所以 cluster-reader 被限制到当前命名空间</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="RBAC授权"><a href="#RBAC授权" class="headerlink" title="RBAC授权"></a>RBAC授权</h2><p>在 bind 授权的时候，可以绑定的用户主体有：user、group</p>
<ul>
<li>使用 rolebinding 和 clusterrolebinding 绑定</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">绑定到 user：表示只有这一个用户拥有 role 或者 clusterrole 的权限</span><br><span class="line">绑定到 group：表示这个组内的所有用户都具有了 role 或者 clusterrole 的权限</span><br></pre></td></tr></table></figure>
<ul>
<li>创建用户时候加入组，加入组后账户自动集成该组的权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建私钥</span></span><br><span class="line">(<span class="built_in">umask</span> 077; openssl genrsa -out jinheng.key 2048)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书签署请求，O 是组，CN 就是账号，这个账号被 k8s 用来识别身份，授权也需要授权这个账号</span></span><br><span class="line">openssl req -new -key jinheng.key -out jinheng.csr -subj <span class="string">"O=system:masters/CN=jinheng/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 CA 签署证书，并且在 1800 天内有效</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> jinheng.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out jinheng.crt -days 1800</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> jinheng.crt -text -noout</span><br></pre></td></tr></table></figure>
<h1 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h1><p>它作为 k8s 集群的附件存在，是 kubernetes 官方的项目之一，详见：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a></p>
<h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><ul>
<li>为 dashboard 提供 ssl 证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">(<span class="built_in">umask</span> 077; openssl genrsa -out dashboard.key 2048)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个自签证书，注意 CN 的值必须要与自己的域名完全一致</span></span><br><span class="line">openssl req -new -x509 -key dashboard.key -out dashboard.crt -subj <span class="string">"/O=dashboard/CN=k8s.dashboard.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> dashboard.crt -text -noout</span><br></pre></td></tr></table></figure>
<ul>
<li>下载 dashboard 的清单文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">wget</span> <span class="attr">https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure>
<ul>
<li>为 dashboard 创建 secret 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system create secret generic kubernetes-dashboard-certs --from-file=dashboard.crt=./dashboard.crt --from-file=dashboard.key=./dashboard.key</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 dashboard 清单中 service 的工作模式为 nodeport</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">'/targetPort: 8443/a\ \ type: NodePort'</span> kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>注释掉 kubernetes-dashboard.yaml 清单文件中的 Dashboard Secret 这个证书的清单定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ------------------- Dashboard Secret ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#apiVersion: v1</span></span><br><span class="line"><span class="comment">#kind: Secret</span></span><br><span class="line"><span class="comment">#metadata:</span></span><br><span class="line"><span class="comment">#  labels:</span></span><br><span class="line"><span class="comment">#    k8s-app: kubernetes-dashboard</span></span><br><span class="line"><span class="comment">#  name: kubernetes-dashboard-certs</span></span><br><span class="line"><span class="comment">#  namespace: kube-system</span></span><br><span class="line"><span class="comment">#type: Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---</span></span><br></pre></td></tr></table></figure>
<ul>
<li>部署 dashboard 清单</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>取得 service 运行的端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get service -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 chrome 访问 dashboard</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://172.16.100.102:31097/</span><br></pre></td></tr></table></figure>
<h2 id="使用令牌登录"><a href="#使用令牌登录" class="headerlink" title="使用令牌登录"></a>使用令牌登录</h2><ul>
<li>为 POD 创建一个 serviceaccount 对象，它是 POD 访问 apiserver 的凭证</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount dashborad-admin -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 clusterrolebinding 将用户绑定至 cluster-admin 集群管理员（最高权限）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding dashborad-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashborad-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>找到刚才创建的 serviceaccount 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>得到 serviceaccount 对象中的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret -n kube-system dashborad-admin</span><br></pre></td></tr></table></figure>
<h2 id="权限分级"><a href="#权限分级" class="headerlink" title="权限分级"></a>权限分级</h2><p>现在需要创建一个只能管理 default 名称空间的用户，那么我们可以用 rolebinding 去绑定 admin 这个 clusterrolue 对象，那么就获得了当前名称空间的管理员权限了。</p>
<ul>
<li>创建 serviceaccount 登录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount def-ns-admin -n default</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 rolebinding 对象，将 default 名称空间的 def-ns-admin 这个 serviceaccunt 与 admin 这个 clusterrole 绑定 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>找到刚才创建的 serviceaccount 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>得到 serviceaccount 对象中的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret def-ns-admin</span><br></pre></td></tr></table></figure>
<h2 id="配置文件认证"><a href="#配置文件认证" class="headerlink" title="配置文件认证"></a>配置文件认证</h2><p>与之前基于 SSL 证书的 config 文件不同，这次使用是基于 Token 的 config 文件，可以不用创建证书了，使用已有的 serviceaccount 对象的 token。</p>
<ul>
<li>设置集群的连接的 ca 机构证书，–kubeconfig 可以指定 kubectl 使用的配置文件位置，默认为用户家目录 .kube 目录中的 config</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-cluster k8s-cluster --server=https://172.16.100.101:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=<span class="literal">true</span> --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>取得一个已经绑定角色的 serviceaccount 对象的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret def-ns-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 Token 来创建配置文件中的用户</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials def-ns-admin --token=&lt;TOKEN&gt; --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>创建上下文对象，授权 jinheng 用户访问名称为 kubernetes 的集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context def-ns-admin@k8s-cluster --cluster=k8s-cluster --user=def-ns-admin --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>切换当前使用的上下文，到授权 jinheng 到 kubernetes 的上下文上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context def-ns-admin@k8s-cluster --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>复制 /tmp/test.conf 这个文件到 dashboard 中就可以登录了</li>
</ul>
<h1 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h1><p>K8S 的网络通信完全由 CNI 接口上的插件来实现，插件需要实现以下集中通信模型。</p>
<p>目前比较流行的插件有：flannel、calico、canel、kube-router …</p>
<ul>
<li>如何加载插件</li>
</ul>
<p>k8s 在启动的时候会去：/etc/cni/net.d/ 目录下寻找网络插件的配置文件，POD 在创建时候 k8s 调用这个配置文件，由插件根据这个配置文件进行创建网络。</p>
<h2 id="通信模型"><a href="#通信模型" class="headerlink" title="通信模型"></a>通信模型</h2><ol>
<li>容器间通信：同一个 POD 内多个容器间的通信，使用 lo 网卡通信</li>
<li>POD间通信：POD IP 直接与 POD IP 通信</li>
<li>POD 与 Service：POD IP 直接与 Cluster IP</li>
<li>Service 与集群外部客户端的通信，ingress、NodePort、Loadbacer</li>
</ol>
<h2 id="通信模型底层"><a href="#通信模型底层" class="headerlink" title="通信模型底层"></a>通信模型底层</h2><p>无论哪一种网络插件，它们用到的底层方案都是以下几种：</p>
<ol>
<li>虚拟网桥：brg，用纯软件实现一个虚拟网卡，一端在POD上，一端在宿主机上接入到网桥或物理接口桥上，称为隧道网络。</li>
<li>多路复用：MacVLAN，基于 MAC 的方式创建 VLAN ，为每个虚拟接口配置一个独立的 MAC 地址，使得一个物理网卡承载多个容器使用，这样容器直接使用物理网卡，基于 MacVLAN 进行跨节点通信。</li>
<li>硬件交换：网卡支持硬件交换，SR-IOV （单根-IO虚拟化） 方式，这种网卡支持直接在物理级别虚拟出多个接口，高性能。</li>
</ol>
<h2 id="K8S-名称空间"><a href="#K8S-名称空间" class="headerlink" title="K8S 名称空间"></a>K8S 名称空间</h2><p>K8S 名称空间与 POD 网络名称空间不在一个维度，所以即使在不同的 K8S 集群名称空间内创建的不同 POD，也可以通过网络直接通信。</p>
<p>而目前应用最广的 flannel 网络插件，是不支持这种不同集群命名空间的网络隔离策略的。</p>
<p>calico 支持地址分配，也支持不同集群命名空间的网络隔离策略，但是它使用较为复杂，支持 BGP 三层网络转发，性能比 flannel 强。</p>
<p>也可以使用 flannel 来做网络管理，再安装 calico 仅仅做集群命名空间网路隔离策略，这种搭配方案。</p>
<h2 id="K8s-网络拓扑"><a href="#K8s-网络拓扑" class="headerlink" title="K8s 网络拓扑"></a>K8s 网络拓扑</h2><p>所有 POD 连接到，本机 cni0 接口这个网络，cni0 接口发出的报文到达 flannel.1 这个接口，这个接口将报文封装为隧道协议，通过本机的真实的物理网卡发出。</p>
<ul>
<li>查看本机的接口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1: lo:                       <span class="comment"># 本地回环</span></span><br><span class="line">2: ens33:                    <span class="comment"># 主机物理网卡</span></span><br><span class="line">3: docker0:                  <span class="comment"># docker 默认的桥接网络，在 k8s 中无用可以删除</span></span><br><span class="line">4: dummy0:                   <span class="comment"># </span></span><br><span class="line">5: kube-ipvs0:               <span class="comment"># </span></span><br><span class="line">6: flannel.1:                <span class="comment"># flannel 虚拟网卡，封装隧道报文</span></span><br><span class="line">7: cni0:                     <span class="comment"># 所有容器处于这个网桥</span></span><br><span class="line">8: veth0c014b8b@if3:         <span class="comment"># 容器的网卡连接到 cni0</span></span><br><span class="line">9: veth97c048e5@if3:         <span class="comment"># 容器的网卡连接到 cni0</span></span><br><span class="line">11: vethd2f0bf2b@if3:        <span class="comment"># 容器的网卡连接到 cni0</span></span><br><span class="line">12: veth648a500f@if3:        <span class="comment"># 容器的网卡连接到 cni0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>下载 bridge-utils 包使用命令 brctl show cni0 查看 cni0 接口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bridge    name    bridge id           STP    enabled    interfaces</span><br><span class="line">cni0              8000.9a6ec95f8285   no		        veth0c014b8b</span><br><span class="line">                                                        veth648a500f</span><br><span class="line">                                                        veth7a3f56b7</span><br><span class="line">                                                        veth97c048e5</span><br><span class="line">                                                        vethd2f0bf2b</span><br></pre></td></tr></table></figure>
<h1 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h1><p>flannel 是一个专为 kubernetes 定制的三层网络解决方案，主要用于解决容器的跨主机通信问题。</p>
<h2 id="flannel-工作模式"><a href="#flannel-工作模式" class="headerlink" title="flannel 工作模式"></a>flannel 工作模式</h2><ul>
<li>flannel.1 这个虚拟网卡支持多种传输模式：VxLAN、host-gw、Directrouting、udp </li>
</ul>
<table>
<thead>
<tr>
<th>模式</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>VXLAN</td>
<td>使用 VxLAN 作为隧道封装报文</td>
</tr>
<tr>
<td>host-gw</td>
<td>不使用叠加网络，而是在主机的路由表中创建到其他主机 subnet 的路由条目，性能较好，缺陷是：所有 node 节点必须处于同一个二层网络中。</td>
</tr>
<tr>
<td>DirectRouting</td>
<td>当主机位于同一子网时启用直接路由，不在回退到 VxLAN。</td>
</tr>
<tr>
<td>UDP</td>
<td>直接使用 UDP 协议，性能差</td>
</tr>
</tbody>
</table>
<h2 id="VXLAN-通信过程"><a href="#VXLAN-通信过程" class="headerlink" title="VXLAN 通信过程"></a>VXLAN 通信过程</h2><p>Flannel VXLAN 实质上是一种 “覆盖网络(overlay network)” ，也就是将TCP数据包装在另一种网络包里面进行路由转发和通信，目前已经支持UDP、VxLAN、AWS VPC和GCE路由等数据转发方式。</p>
<ul>
<li>flannel VXLAN 通信过程</li>
</ul>
<p>在 K8S 上 POD 与 POD 是直接通过对方的 IP 地址进行通信的，POD 发出的报文经过 cni0 网桥到达 flannel ，flannel 将报文封装上一层 VxLAN 的首部，外层又被封装一层 UDP 协议的首部，发送给本机物理网卡，本机物理网卡又将 flannel 发过来的报文外层封装上 IP 首部和以太网帧首部（MAC）由网卡发出，另外一个 node 节点收到报文，内核发现是一个 VxLAN 的包，拆掉 IP 首部送给 flannel 应用程序，flannel 拆掉 VxLAN 首部并将内部的数据发送给，cni0 网桥，cni0 收到后转发给 POD。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|                                               |                                   |</span><br><span class="line">|&lt;------------------ VxLAN封装 -----------------&gt;|&lt;----------- 原始报文 -------------&gt;|</span><br><span class="line">+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">|  node 网络 |  node网络  | node 网络 |  VxLan    |   POD MAC |  POD IP   |    data   |</span><br><span class="line">|  帧首部MAC |   IP首部   | UDP 首部  |   首部     |    首部    |   首部    |  Payload  |</span><br><span class="line">+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br></pre></td></tr></table></figure>
<h2 id="flannel-部署方式"><a href="#flannel-部署方式" class="headerlink" title="flannel 部署方式"></a>flannel 部署方式</h2><ol>
<li>在 k8s 集群启动前，flannel 直接部署到节点上，作为一个守护进程运行。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">任何一个部署了 kubelet 的节点都应该部署 flannel ，因为 kubelet 要借助 flannel 为 POD 设置网络接口</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用 kube-admin 直接将 k8s 自己的组件包括 flannel 运行在 k8s 之上的静态 POD。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">必须配置为共享 node 节点网络名称空间的 POD，所以 flannel POD 控制器为 DaemonSet。</span><br></pre></td></tr></table></figure>
<h2 id="flannel-配置文件"><a href="#flannel-配置文件" class="headerlink" title="flannel 配置文件"></a>flannel 配置文件</h2><ul>
<li>配置文件选项含义</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "Network": "10.244.0.0/16",     // flannel 使用的 CIDR 格式的网络地址，用于为 POD 配置网络功能</span><br><span class="line">	"SubnetLen": 24,                // 把 Network 切分为子网供各 node 节点使用时，使用多长的掩码切分，默认为 24</span><br><span class="line">	"SubnetMin": "10.244.10.0/24",  // 用于分配给 node 的子网起始地址，从这个网络开始分配网络</span><br><span class="line">    "SubnetMax": "10.244.255.0/24"  // 用于分配给 nide 的子网结束位置，这个是最大分配的网路  </span><br><span class="line">    "Backend": &#123;                    // 指明 POD 与 POD 跨节点通信时候使用的 flannel 工作模式</span><br><span class="line">        "Type": "vxlan",            // 工作模式</span><br><span class="line">    	"Directrouting": true       // 是否使用直接路由模式</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>flannel 托管到 k8s 上的配置文件，处于 kube-flannel-cfg 这个 configmap 中。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get configmap kube-flannel-cfg -n kube-system -o json</span><br></pre></td></tr></table></figure>
<h2 id="修改工作模式"><a href="#修改工作模式" class="headerlink" title="修改工作模式"></a>修改工作模式</h2><ul>
<li>修改 flannel 工作模式，添加 Directrouting，这个操作应该在刚刚部署完 k8s 集群时候修改，推荐修改</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit configmap kube-flannel-cfg -n kube-system</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"Backend"</span>: &#123;</span><br><span class="line">    <span class="string">"Type"</span>: <span class="string">"vxlan"</span>,</span><br><span class="line">    <span class="string">"Directrouting"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看本机路由表</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ip route show</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">default via 172.16.100.254 dev ens33 proto static metric 100 </span><br><span class="line">10.244.1.0/24 via 10.244.1.0 dev ens33             <span class="comment"># 必须为 dev 物理网卡接口，否则 Directrouting 没有设置成功</span></span><br><span class="line">10.244.2.0/24 via 10.244.2.0 dev ens33             <span class="comment"># 必须为 dev 物理网卡接口，否则 Directrouting 没有设置成功</span></span><br><span class="line">172.16.100.0/24 dev ens33 proto kernel scope link src 172.16.100.101 metric 100 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1</span><br></pre></td></tr></table></figure>
<h1 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h1><p>Calico 创建和管理⼀个扁平的三层网络(不需要 overlay)，每个容器会分配一个可路由的 ip。由于通信时不需要解包和封包，网络性能损耗小，易于排查，且易于水平扩展。</p>
<p>小规模部署时可以通过 bgp client 直接互联，大规模下可通过指定的 BGP route reflector 来完成，这样保证所有的数据流量都是通过 IP 路由的方式完成互联的。 </p>
<p>Calico 基于 iptables 还提供了丰富而灵活的网络 Policy，保证通过各个节点上的 ACLs 来提供 Workload 的多租户隔离、安全组以及其他可达性限制等功能。</p>
<p>有个新的项目：canel，它集合了 flannel 和 calico 的优点。</p>
<ul>
<li>注意</li>
</ul>
<p>Calico 目前不支持工作在 iptables 下的 kube-proxy，下面介绍 canal 网络策略的使用</p>
<h2 id="安装-canal"><a href="#安装-canal" class="headerlink" title="安装 canal"></a>安装 canal</h2><ul>
<li>下载清单文件，需要翻墙</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/v3.6/getting-started/kubernetes/installation/hosted/canal/canal.yaml</span><br></pre></td></tr></table></figure>
<h2 id="清单定义"><a href="#清单定义" class="headerlink" title="清单定义"></a>清单定义</h2><ul>
<li>清单格式，详见：kubectl explain networkpolicy</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">egress</span>                  <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 出站规则的对象列表</span></span><br><span class="line">  <span class="string">ports</span>                 <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 目标端口的对象列表</span></span><br><span class="line">    <span class="string">port</span>                <span class="string">&lt;string&gt;</span>      <span class="comment"># 数字形式或者是命名的端口</span></span><br><span class="line">    <span class="string">protocol</span>                          <span class="comment"># 协议 TCP、UDP</span></span><br><span class="line">  <span class="string">to</span>                    <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 目标地址对象列表</span></span><br><span class="line">    <span class="string">ipBlock</span>             <span class="string">&lt;Object&gt;</span>      <span class="comment"># 一组 IP 地址</span></span><br><span class="line">      <span class="string">cidr</span>	            <span class="string">&lt;string&gt;</span>      <span class="comment"># CIDR 表示的 IP 范围</span></span><br><span class="line">      <span class="string">except</span>	        <span class="string">&lt;[]string&gt;</span>    <span class="comment"># 排除 CIDR 中的某些地址</span></span><br><span class="line">    <span class="string">namespaceSelector</span>   <span class="string">&lt;Object&gt;</span>      <span class="comment"># 名称空间选择器</span></span><br><span class="line">    <span class="string">podSelector</span>         <span class="string">&lt;Object&gt;</span>      <span class="comment"># POD 选择器，目标地址可以也是一组 POD</span></span><br><span class="line"><span class="string">ingress</span>                 <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 入站规则的对象列表</span></span><br><span class="line">  <span class="string">from</span>                  <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 源地址对象列表</span></span><br><span class="line">    <span class="string">ipBlock</span>             <span class="string">&lt;Object&gt;</span>      <span class="comment"># 一组 IP 地址</span></span><br><span class="line">      <span class="string">cidr</span>	            <span class="string">&lt;string&gt;</span>      <span class="comment"># CIDR 表示的 IP 范围</span></span><br><span class="line">      <span class="string">except</span>	        <span class="string">&lt;[]string&gt;</span>    <span class="comment"># 排除 CIDR 中的某些地址</span></span><br><span class="line">    <span class="string">namespaceSelector</span>   <span class="string">&lt;Object&gt;</span>      <span class="comment"># 名称空间选择器</span></span><br><span class="line">    <span class="string">podSelector</span>         <span class="string">&lt;Object&gt;</span>      <span class="comment"># POD 选择器，源地址也可以是一组 POD</span></span><br><span class="line">  <span class="string">ports</span>                 <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># POD 自己的端口，表示控制自己的端口是否可以被访问，的对象列表</span></span><br><span class="line">    <span class="string">port</span>                              <span class="comment"># 数字形式或者是命名的端口</span></span><br><span class="line">    <span class="string">protocol</span>                          <span class="comment"># 协议 TCP、UDP</span></span><br><span class="line"><span class="string">podSelector</span>             <span class="string">&lt;Object&gt;</span>      <span class="comment"># POD 选择器决定规则应用在哪些 POD 上</span></span><br><span class="line"><span class="string">policyTypes</span>             <span class="string">&lt;[]string&gt;</span>    <span class="comment"># 可以是 "Ingress", "Egress", 或者 "Ingress,Egress" ，表示放行满足这些规则访问</span></span><br></pre></td></tr></table></figure>
<h2 id="policyTypes"><a href="#policyTypes" class="headerlink" title="policyTypes"></a>policyTypes</h2><ul>
<li>首先定义 名称空间</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create namespace dev</span><br><span class="line">kubectl create namespace prod</span><br></pre></td></tr></table></figure>
<ul>
<li>在两个命名空间分别创建一个 POD</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f pod-a.yaml -n dev</span><br></pre></td></tr></table></figure>
<ul>
<li>拒绝所有 dev 空间的报文</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">deny-all-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  podSelector:</span> <span class="string">&#123;&#125;</span>            <span class="comment"># &#123;&#125; 空的选择器表示选择全部</span></span><br><span class="line"><span class="attr">  policyTypes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">Ingress</span>                  <span class="comment"># 指明 Ingress 规则生效，匹配 Ingress 将被放行，如果没定义 Ingress 则不能匹配所有，会拒绝全部</span></span><br><span class="line">                             <span class="comment"># policyTypes 没有 Egress 表示不控制 Egress ，默认为允许</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在指定命名空间应用规则文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f deny-all-ingress.yaml -n dev</span><br></pre></td></tr></table></figure>
<ul>
<li>查看规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get networkpolicy -n dev</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 dev 空间中的 POD 地址并访问，结果是不能访问，因为这个命名空间拒绝外部访问</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods -n dev -o wide</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl 10.244.1.2</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 prod 空间中的 POD 地址并访问，结果可以访问，因为这个命名空间没有定义规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods -n dev -o wide</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl 10.244.2.2</span><br></pre></td></tr></table></figure>
<ul>
<li>允许指定网段的 POD 访问本 POD 的 80 端口</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">allow-80-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  podSelector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">  - from:</span></span><br><span class="line"><span class="attr">    - ipBlock:</span>                   <span class="comment"># 指定源地址为 IP 地址块 </span></span><br><span class="line"><span class="attr">        cidr:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>    <span class="comment"># 掩码形式指出源地址 IP 地址范围</span></span><br><span class="line"><span class="attr">        except:</span>                  <span class="comment"># 排除 cidr 范围内的某个地址</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">10.244</span><span class="number">.1</span><span class="number">.2</span><span class="string">/32</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span>                   <span class="comment"># 入栈且目标端口为 80 的则匹配</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  policyTypes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">Ingress</span>                  <span class="comment"># 指明 Ingress 规则生效，匹配 Ingress 将被放行，如果没定义 Ingress 则不能匹配所有，拒绝全部</span></span><br><span class="line">                             <span class="comment"># policyTypes 没有 Egress 表示不控制 Egress ，默认为允许</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get networkpolicy -n dev</span><br></pre></td></tr></table></figure>
<ul>
<li>拒绝出栈的所有请求</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">deny-all-egress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  podSelector:</span> <span class="string">&#123;&#125;</span>            <span class="comment"># &#123;&#125; 空的选择器表示选择全部</span></span><br><span class="line"><span class="attr">  policyTypes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">Egress</span>                   <span class="comment"># 指明 Egress 规则生效，匹配 Egress 将被放行，如果没定义 Egress 则不能匹配所有，拒绝全部</span></span><br><span class="line">                             <span class="comment"># policyTypes 没有 Ingress 表示不控制 Egress ，默认为允许</span></span><br></pre></td></tr></table></figure>
<h1 id="调度策略"><a href="#调度策略" class="headerlink" title="调度策略"></a>调度策略</h1><p>Master 主要是运行集群的控制平面组件的，apiserver、scheduler、controlermanager，Master 还依赖与 etcd 这样的存储节点。</p>
<p>kubeadm 部署的集群会将 Master 的控制组件都运行为静态 POD 了，从本质来讲，这些组件就是运行在 Master 节点专为集群提供服务的进程，Master 是不负责运行工作负载的。</p>
<p>node 节点是负责运行工作负载 POD 的相关节点，用户只需要将运行任务提交给 Master 就可以了，用户无需关心运行在哪个 node 节点上，Master 整合了所有 node 为一个虚拟的资源池。</p>
<h2 id="POD创建流程"><a href="#POD创建流程" class="headerlink" title="POD创建流程"></a>POD创建流程</h2><p>用户创建的任务最终应该运行在哪个 node 节点上，是由 Master 节点上的 scheduler 决定的，而 scheduler 也是允许用户定义它的工作特性的，默认情况下，我们没有定义它，其实是使用的默认的 scheduler 调度器。</p>
<p>当我们使用 kubectl describe pods myapp 查看 POD 信息时候，会有一个 Events 字段中，有关于调度结果的相关信息。</p>
<p>Scheduler 会从众多的 node 节点中挑选出符合 POD 运行要求的节点，然后将选定的 node 节点信息记录在 etcd 中，kubelet 始终 waitch 着 apiserver 上的关于本节点的信息变化，kubelet 就会去 apiserver 获取关于变化信息的配置清单，根据配置清单的定义去创建 POD。</p>
<h2 id="Service创建过程"><a href="#Service创建过程" class="headerlink" title="Service创建过程"></a>Service创建过程</h2><p>当用户创建一个 service 的时候，这个请求会提交给 apiserver，apiserver 将清单文件写入 etcd 中，然后每个 node 节点上的 kube-proxy 会 waitch apiserver 关于 service 资源的相关变动，发生变化时候，每个节点的 kube-proxy 会将 service 创建为 iptables/ipvs 规则。</p>
<p>从通信角度来讲：kubectl、kubelet、kube-proxy 都是 apiserver 的客户端，这些组件与 apiserver 进行交互时候，数据格式为 json，内部的数据序列化方式为 protocolbuff。</p>
<h2 id="资源限制维度"><a href="#资源限制维度" class="headerlink" title="资源限制维度"></a>资源限制维度</h2><ol>
<li>资源需求：运行 POD 需要的最低资源需求</li>
<li>资源限制：POD 可以占用的最高资源限额</li>
</ol>
<h2 id="Scheduler-调度过程"><a href="#Scheduler-调度过程" class="headerlink" title="Scheduler 调度过程"></a>Scheduler 调度过程</h2><ol>
<li>预选阶段：排除完全不符合运行这个 POD 的节点、例如资源最低要求、资源最高限额、端口是否被占用</li>
<li>优选阶段：基于一系列的算法函数计算出每个节点的优先级，按照优先级排序，取得分最高的 node</li>
<li>选中阶段：如果优选阶段产生多个结果，那么随机挑选一个节点</li>
</ol>
<ul>
<li>POD 中影响调度的字段，在 kubectl explain pods.spec 中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nodeName          <span class="comment"># 直接指定 POD 的运行节点</span></span><br><span class="line">nodeSelector      <span class="comment"># 根据 node 上的标签来对 node 进行预选，这就是节点的亲和性</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其他影响调度的因素</li>
</ul>
<p>节点亲和性调度：表现为 nodeSelector 字段</p>
<p>POD 间亲和性：POD 更倾向和某些 POD 运行在一起，例如同一个机房、同一个机器</p>
<p>POD 间反亲和性：POD 和某 POD 更倾向不能运行在一起，这叫反亲和性，例如：监听同一个 nodeport，有机密数据的</p>
<p>Taints（污点）：给某些 node 打上污点，</p>
<p>Tolerations（污点容忍）：一个 POD 能够容忍 node 上的污点，如果运行过程中 node 出现新的污点，那么 POD 可以</p>
<p>驱逐POD：node 给一个限定的时间，让 POD 离开这个节点。</p>
<h2 id="预选因素"><a href="#预选因素" class="headerlink" title="预选因素"></a>预选因素</h2><p>下面的预选条件需要满足所有的预选条件才可以通过预选</p>
<ol>
<li>CheckNodeConditionPred</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">检查节点是否正常</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>GeneralPredicates</li>
</ol>
<table>
<thead>
<tr>
<th>子策略</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>HostName</td>
<td>检查主机名称是不是 pod.spec.hostname 指定的 NodeName</td>
</tr>
<tr>
<td>PodFitsHostPorts</td>
<td>检查 Pod 内每一个容器 pods.spec.containers.ports.hostPort 清单是否已被其它容器占用，如果有所需的 HostPort 不满足需求，那么 Pod 不能调度到这个主机上</td>
</tr>
<tr>
<td>MatchNodeSelector</td>
<td>检查 POD 容器上定义了 pods.spec.nodeSelector 查看 node 标签是否能够匹配</td>
</tr>
<tr>
<td>PodFitsResources</td>
<td>检查 node 是否有足够的资源运行此 POD 的基本要求</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>NoDiskConflict（默认没有启用）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">检查 pod 定义的存储是否在 node 节点上使用。</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>PodToleratesNodeTaints</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查节点的污点 nodes.spec.taints 是否是 POD 污点容忍清单中 pods.spec.tolerations 的子集</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>PodToleratesNodeNoExecuteTaints</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查 pod 是否容忍节点上有 NoExecute 污点。NoExecute 这个污点是啥意思呢。如果一个 pod 上运行在一个没有污点的节点上后，这个节点又给加上污点了，那么 NoExecute 表示这个新加污点的节点会驱逐其上正在运行的 pod；不加 NoExecute 不会驱逐节点上运行的 pod，表示接受既成事实，这是默认策略。</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>CheckNodeLabelPresence（默认没有启用）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查节点上指定标签的存在性，如果节点有pod指定的标签，那么这个节点就被选中。</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>CheckServiceAffinity（默认没有启用）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个 Service 下可以有多个 POD，比如这些 POD 都运行在 1、2、3 机器上，而没有运行在 4、5、6 机器上，那么CheckServiceAffinity 就表示新加入的 POD 都集中运行在 1、2、3 机器上，这样集中好处是一个 Service 下 POD 之间内部通信的效率变高了。</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>MaxEBSVolumeCount</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">确保已挂载的亚马逊 EBS 存储卷不超过设置的最大值，默认39</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>MaxGCEPDVolumeCount</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">确保已挂载的GCE存储卷不超过设置的最大值，默认16</span><br></pre></td></tr></table></figure>
<p>10 MaxAzureDiskVolumeCount</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">确保已挂载的Azure存储卷不超过设置的最大值，默认16</span><br></pre></td></tr></table></figure>
<ol start="11">
<li>CheckVolumeBinding</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查节点上的 PVC 是否被别的 POD 绑定了</span><br></pre></td></tr></table></figure>
<ol start="12">
<li>NoVolumeZoneConflict</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查给定的 zone (机房) 限制前提下，检查如果在此主机上部署 POD 是否存在卷冲突</span><br></pre></td></tr></table></figure>
<ol start="13">
<li>CheckNodeMemoryPressure</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查 node 节点上内存是否存在压力</span><br></pre></td></tr></table></figure>
<ol start="14">
<li>CheckNodeDiskPressure</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查磁盘 IO 是否压力过大</span><br></pre></td></tr></table></figure>
<ol start="15">
<li>CheckNodePIDPressure</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查 node 节点上 PID 资源是否存在压力</span><br></pre></td></tr></table></figure>
<ol start="16">
<li>MatchInterPodAffinity</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">检查 Pod 是否满足亲和性或者反亲和性</span><br></pre></td></tr></table></figure>
<h2 id="优选函数"><a href="#优选函数" class="headerlink" title="优选函数"></a>优选函数</h2><p>在每个节点执行优选函数，将结果每个优选函数相加，得分最高的胜出。</p>
<ol>
<li>least_requested.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">选择消耗最小的节点（根据空闲比率评估 cpu(总容量-sum(已使用)*10/总容量)）</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>balanced_resource_allocation.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">均衡资源的使用方式，表示以 cpu 和内存占用率的相近程度作为评估标准，二者占用越接近，得分就越高，得分高的胜出。</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>node_prefer_avoid_pods.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">看节点是否有注解信息 &quot;scheduler.alpha.kubernetes.io/preferAvoidPods&quot; 。没有这个注解信息，说明这个节点是适合运行这个 POD 的。</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>taint_toleration.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">将 pods.spec.tolerations 与 nodes.spec.taints 列表项进行匹配度检查，匹配的条目越多，得分越低。</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>selector_spreading.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">查找当前 POD 对象对应的 service、statefulset、replicatset 等所匹配的标签选择器，在节点上运行的带有这样标签的 POD 越少得分越高，这样的 POD 优选被选出。 这就是说我们要把同一个标签选择器下运行的 POD 散开(spreading)到多个节点上。</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>interpod_affinity_test.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">遍历 POD 对象亲和性的条目，并将那些能够匹配到节点权重相加，值越大的得分越高，得分高的胜出。</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>most_requested.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">表示尽可能的把一个节点的资源先用完，这个和 least_requested 相反，二者不能同时使用。</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>node_label.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">根据节点是否拥有标签，不关心标签是什么，来评估分数。</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>image_locality.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">表示根据满足当前 POD 对象需求的已有镜的体积大小之和来选择节点的。</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>node_affinity.go</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">根据 POD 对象中的 nodeselector，对节点进行匹配度检查，能够成功匹配的数量越多，得分就越高。</span><br></pre></td></tr></table></figure>
<h2 id="选择函数"><a href="#选择函数" class="headerlink" title="选择函数"></a>选择函数</h2><p>当通过优选的节点有多个，那么从中随机选择一台</p>
<h1 id="高级调度设置"><a href="#高级调度设置" class="headerlink" title="高级调度设置"></a>高级调度设置</h1><p>节点选择器：nodeselector、nodeName</p>
<p>节点亲和调度：nodeAffinity</p>
<h2 id="节点选择器"><a href="#节点选择器" class="headerlink" title="节点选择器"></a>节点选择器</h2><ul>
<li>使用 nodeselector 来将预选范围缩小，没有被 nodeselector 选中的节点将被预选阶段淘汰</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-schedule-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    gpu:</span> <span class="string">ok</span></span><br></pre></td></tr></table></figure>
<ul>
<li>此时如果没有任何一个节点有 gpu 这个标签，那么这个 POD 的调度将会被挂起，Pending 状态，直到满足条件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label nodes node2 gpu=ok --overwrite</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 POD 被调度的节点，POD 已经被调度到 node2 节点了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods -o wide</span><br></pre></td></tr></table></figure>
<h2 id="对节点的亲和性"><a href="#对节点的亲和性" class="headerlink" title="对节点的亲和性"></a>对节点的亲和性</h2><p>亲和性定义，详见：kubectl explain pods.spec.affinity.nodeAffinity</p>
<ul>
<li>POD 对节点亲和性定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nodeAffinity             &lt;Object&gt;                                <span class="comment"># POD 对 node 节点的亲和性</span></span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution  &lt;[]Object&gt;    <span class="comment"># 软亲和性要求，尽量满足亲和性</span></span><br><span class="line">    preference           &lt;Object&gt;                                <span class="comment"># 亲和的节点对象</span></span><br><span class="line">      matchExpressions   &lt;[]Object&gt;                              <span class="comment"># 查找表达式</span></span><br><span class="line">        key              &lt;string&gt;                                <span class="comment"># 标签</span></span><br><span class="line">        operator         &lt;string&gt;                                <span class="comment"># 操作：比较</span></span><br><span class="line">        values           &lt;[]string&gt;                              <span class="comment"># 值</span></span><br><span class="line">      matchFields        &lt;[]Object&gt;                              <span class="comment"># 查找字段</span></span><br><span class="line">        key              &lt;string&gt;                                <span class="comment"># 标签</span></span><br><span class="line">        operator         &lt;string&gt;                                <span class="comment"># 操作：比较</span></span><br><span class="line">        values           &lt;[]string&gt;                              <span class="comment"># 值</span></span><br><span class="line">    weight               &lt;<span class="built_in">integer</span>&gt;                               <span class="comment"># 权重 1 - 100</span></span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution   &lt;Object&gt;      <span class="comment"># 硬亲和性要求，不满足则 Pending</span></span><br><span class="line">    nodeSelectorTerms    &lt;[]Object&gt;                              <span class="comment"># 选择器对象列表</span></span><br><span class="line">      matchExpressions   &lt;[]Object&gt;                              <span class="comment"># 选择器对象列表</span></span><br><span class="line">        key              &lt;string&gt;                                <span class="comment"># 标签</span></span><br><span class="line">        operator         &lt;string&gt;                                <span class="comment"># 操作：比较</span></span><br><span class="line">        values           &lt;[]string&gt;                              <span class="comment"># 值</span></span><br><span class="line">      matchFields        &lt;[]Object&gt;                              <span class="comment"># 查找字段</span></span><br><span class="line">        key              &lt;string&gt;                                <span class="comment"># 标签</span></span><br><span class="line">        operator         &lt;string&gt;                                <span class="comment"># 操作：比较</span></span><br><span class="line">        values           &lt;[]string&gt;                              <span class="comment"># 值</span></span><br></pre></td></tr></table></figure>
<ul>
<li>示例配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-nodeaffinity1-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    nodeAffinity:</span></span><br><span class="line"><span class="attr">      requiredDuringSchedulingIgnoredDuringExecution:</span>        <span class="comment"># 硬亲和性要求，不满足就 Pending</span></span><br><span class="line"><span class="attr">        nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">        - matchExpressions:</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">zone</span></span><br><span class="line"><span class="attr">            operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">            values:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">foo</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">bar</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-nodeaffinity2-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    nodeAffinity:</span></span><br><span class="line"><span class="attr">      preferredDuringSchedulingIgnoredDuringExecution:</span>     <span class="comment"># 软亲和性要求，不满足也可以对凑</span></span><br><span class="line"><span class="attr">      - preference:</span></span><br><span class="line"><span class="attr">          matchExpressions:</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">zone</span></span><br><span class="line"><span class="attr">            operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">            values:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">foo</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">bar</span></span><br><span class="line"><span class="attr">        weight:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果，kubectl get pods</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-nodeaffinity1-demo   0/1     Pending   0          6m16s  <span class="comment"># 硬亲和性要求，没有就等待</span></span><br><span class="line">pod-nodeaffinity2-demo   1/1     Running   0          7s     <span class="comment"># 软亲和性要求，没有合适主机也可以凑和</span></span><br></pre></td></tr></table></figure>
<h2 id="对-POD-的亲和性"><a href="#对-POD-的亲和性" class="headerlink" title="对 POD 的亲和性"></a>对 POD 的亲和性</h2><p>POD 和 POD 出于高效的通信这种需求，所以需要将 POD 和 POD 组织在同一台机器，同一个机房，例如：LNMT 如果能运行在同一个主机上更好。</p>
<ol>
<li><p>想把一组 POD 运行在一起，使用节点亲和性就可以实现，为了达成这个目的，我们需要：把节点标签精心编排，希望在一起运行的 POD，就使用同一组标签选择器来选择节点，这种方式需要管理节点标签和 POD 亲和性才能做到。</p>
</li>
<li><p>想把一组 POD 运行在一起，使用 POD 亲和性，我们可以设置 POD 对某个 POD 的亲和性，那么比如：LNMT，那么 MySQL 和 Tomcat 可以设置为更加亲和 Ngninx 所在的主机或机柜，所以必须有个前提就是 POD 和 POD 怎么才是最近的，这个标准是什么，也就是什么是同一位置，怎么才能知道 node 和 node 是在一个机柜。</p>
<p>所以可以为同一个机柜的 node 节点打上相同的标签。</p>
</li>
<li><p>MySQL 和 Tomcat 一定不能和 Nginx 运行在一起，这就是反亲和性。</p>
</li>
</ol>
<ul>
<li>POD 对其他 POD 的亲和性，详见：kubectl explain pods.spec.affinity.podAffinity</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">podAffinity</span>                <span class="string">&lt;Object&gt;</span>                              <span class="comment"># POD 对其他 POD 的亲和性</span></span><br><span class="line">  <span class="string">preferredDuringSchedulingIgnoredDuringExecution</span>  <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 软性亲和性，尽量满足亲和性</span></span><br><span class="line">    <span class="string">podAffinityTerm</span>        <span class="string">&lt;Object&gt;</span>                              <span class="comment"># 亲和的 POD 对象</span></span><br><span class="line">      <span class="string">labelSelector</span>        <span class="string">&lt;Object&gt;</span>                              <span class="comment"># 标签选择器对象列表</span></span><br><span class="line">        <span class="string">matchExpressions</span>   <span class="string">&lt;[]Object&gt;</span>                            <span class="comment"># 标签选择器对象，选 POD 标签</span></span><br><span class="line">          <span class="string">key</span>              <span class="string">&lt;string&gt;</span>                              <span class="comment"># 标签</span></span><br><span class="line">          <span class="string">operator</span>         <span class="string">&lt;string&gt;</span>                              <span class="comment"># 操作：比较</span></span><br><span class="line">          <span class="string">values</span>           <span class="string">&lt;[]string&gt;</span>                            <span class="comment"># 值</span></span><br><span class="line">        <span class="string">matchLabels</span>        <span class="string">&lt;map[string]string&gt;</span>                   <span class="comment"># 集合标签选择器</span></span><br><span class="line">      <span class="string">namespaces</span>           <span class="string">&lt;[]string&gt;</span>                            <span class="comment"># 名称空间的列表</span></span><br><span class="line">      <span class="string">topologyKey</span>	       <span class="string">&lt;string&gt;</span>                              <span class="comment"># 亲和判断条件</span></span><br><span class="line">    <span class="string">weight</span>                 <span class="string">&lt;integer&gt;</span>                             <span class="comment"># 权重 1 - 100</span></span><br><span class="line">  <span class="string">requiredDuringSchedulingIgnoredDuringExecution</span>   <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 硬性亲和性，不满足则 Pending</span></span><br><span class="line">    <span class="string">labelSelector</span>          <span class="string">&lt;Object&gt;</span>                              <span class="comment"># 标签选择器对象列表</span></span><br><span class="line">      <span class="string">matchExpressions</span>   <span class="string">&lt;[]Object&gt;</span>                              <span class="comment"># 标签选择器对象，选 POD 标签</span></span><br><span class="line">        <span class="string">key</span>              <span class="string">&lt;string&gt;</span>                                <span class="comment"># 标签</span></span><br><span class="line">        <span class="string">operator</span>         <span class="string">&lt;string&gt;</span>                                <span class="comment"># 操作：比较</span></span><br><span class="line">        <span class="string">values</span>           <span class="string">&lt;[]string&gt;</span>                              <span class="comment"># 值</span></span><br><span class="line">      <span class="string">matchLabels</span>        <span class="string">&lt;map[string]string&gt;</span>                     <span class="comment"># 集合标签选择器</span></span><br><span class="line">    <span class="string">namespaces</span>             <span class="string">&lt;[]string&gt;</span>                            <span class="comment"># 名称空间的列表</span></span><br><span class="line">    <span class="string">topologyKey</span>            <span class="string">&lt;string&gt;</span>                              <span class="comment"># 亲和判断条件</span></span><br></pre></td></tr></table></figure>
<ul>
<li>示例配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"sh"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"sleep 3600"</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    podAffinity:</span></span><br><span class="line"><span class="attr">      requiredDuringSchedulingIgnoredDuringExecution:</span>   <span class="comment"># 硬亲和性要求，不满足的 Pending</span></span><br><span class="line"><span class="attr">      - labelSelector:</span></span><br><span class="line"><span class="attr">          matchExpressions:</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">            operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">            values:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">        topologyKey:</span> <span class="string">kubernetes.io/hostname</span>             <span class="comment"># 亲和性的依据为同一个主机名则亲和</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果，kubectl get pods -o wide</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME   READY   STATUS    RESTARTS   AGE     IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          3m33s   10.244.2.4   node3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod2   1/1     Running   0          3m33s   10.244.2.5   node3   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="对-POD-的反亲和性"><a href="#对-POD-的反亲和性" class="headerlink" title="对 POD 的反亲和性"></a>对 POD 的反亲和性</h2><ul>
<li>POD 对其他 POD 的反亲和性，详见：kubectl explain pods.spec.affinity.podAntiAffinity</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">podAntiAffinity</span>              <span class="string">&lt;Object&gt;</span>                            <span class="comment"># POD 对其他 POD 的反亲和性</span></span><br><span class="line">  <span class="string">preferredDuringSchedulingIgnoredDuringExecution</span>  <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 软性反亲和性，尽量满足亲和性</span></span><br><span class="line">    <span class="string">podAffinityTerm</span>        <span class="string">&lt;Object&gt;</span>                              <span class="comment"># 反亲和的 POD 对象</span></span><br><span class="line">      <span class="string">labelSelector</span>        <span class="string">&lt;Object&gt;</span>                              <span class="comment"># 标签选择器对象列表</span></span><br><span class="line">        <span class="string">matchExpressions</span>   <span class="string">&lt;[]Object&gt;</span>                            <span class="comment"># 标签选择器对象，选 POD 标签</span></span><br><span class="line">          <span class="string">key</span>              <span class="string">&lt;string&gt;</span>                              <span class="comment"># 标签</span></span><br><span class="line">          <span class="string">operator</span>         <span class="string">&lt;string&gt;</span>                              <span class="comment"># 操作：比较</span></span><br><span class="line">          <span class="string">values</span>           <span class="string">&lt;[]string&gt;</span>                            <span class="comment"># 值</span></span><br><span class="line">        <span class="string">matchLabels</span>        <span class="string">&lt;map[string]string&gt;</span>                   <span class="comment"># 集合标签选择器</span></span><br><span class="line">      <span class="string">namespaces</span>           <span class="string">&lt;[]string&gt;</span>                            <span class="comment"># 名称空间的列表</span></span><br><span class="line">      <span class="string">topologyKey</span>	       <span class="string">&lt;string&gt;</span>                              <span class="comment"># 亲和判断条件</span></span><br><span class="line">    <span class="string">weight</span>                 <span class="string">&lt;integer&gt;</span>                             <span class="comment"># 权重 1 - 100</span></span><br><span class="line">  <span class="string">requiredDuringSchedulingIgnoredDuringExecution</span>   <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 硬性反亲和性，不满足则 Pending</span></span><br><span class="line">    <span class="string">labelSelector</span>          <span class="string">&lt;Object&gt;</span>                              <span class="comment"># 标签选择器对象列表</span></span><br><span class="line">      <span class="string">matchExpressions</span>   <span class="string">&lt;[]Object&gt;</span>                              <span class="comment"># 标签选择器对象，选 POD 标签</span></span><br><span class="line">        <span class="string">key</span>              <span class="string">&lt;string&gt;</span>                                <span class="comment"># 标签</span></span><br><span class="line">        <span class="string">operator</span>         <span class="string">&lt;string&gt;</span>                                <span class="comment"># 操作：比较</span></span><br><span class="line">        <span class="string">values</span>           <span class="string">&lt;[]string&gt;</span>                              <span class="comment"># 值</span></span><br><span class="line">      <span class="string">matchLabels</span>        <span class="string">&lt;map[string]string&gt;</span>                     <span class="comment"># 集合标签选择器</span></span><br><span class="line">    <span class="string">namespaces</span>             <span class="string">&lt;[]string&gt;</span>                            <span class="comment"># 名称空间的列表</span></span><br><span class="line">    <span class="string">topologyKey</span>            <span class="string">&lt;string&gt;</span>                              <span class="comment"># 亲和判断条件</span></span><br></pre></td></tr></table></figure>
<ul>
<li>配置清单</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod4</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"sh"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"sleep 3600"</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    podAntiAffinity:</span></span><br><span class="line"><span class="attr">      requiredDuringSchedulingIgnoredDuringExecution:</span>   <span class="comment"># 硬亲和性要求，不满足的 Pending</span></span><br><span class="line"><span class="attr">      - labelSelector:</span></span><br><span class="line"><span class="attr">          matchExpressions:</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">            operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">            values:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">        topologyKey:</span> <span class="string">kubernetes.io/hostname</span>             <span class="comment"># 反亲和性的依据为同一个主机名</span></span><br></pre></td></tr></table></figure>
<h2 id="taint-污点"><a href="#taint-污点" class="headerlink" title="taint 污点"></a>taint 污点</h2><p>污点只用在 node 上的键值属性（nodes.spec.taints），它的作用是拒绝不能容忍这些污点的 POD 运行的，因此需要在 POD 上定义容忍度（pods.spec.tolerations），它也是键值数据，是一个列表，表示 POD 可以容忍的污点列表。</p>
<p>一个 POD 能不能运行在一个节点上，就是 pods.spec.tolerations 列表中是否包括了 nodes.spec.taints 中的数据。</p>
<ul>
<li>node 污点清单格式，详见：kubectl explain node.spec.taints</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">taints</span>          <span class="string">&lt;[]Object&gt;</span>     <span class="comment"># 污点对象列表</span></span><br><span class="line">  <span class="string">effect</span>        <span class="string">&lt;string&gt;</span>       <span class="comment"># 当 POD 不能容忍这个污点的时候，要采取的行为，也就是排斥不容忍污点的 POD</span></span><br><span class="line">    <span class="string">NoSchedule</span>                 <span class="comment"># 影响调度过程，但是已经调度完成 POD 无影响</span></span><br><span class="line">    <span class="string">PreferNoSchedule</span>           <span class="comment"># 影响调度过程，尝试驱逐调度已经完成的但不容忍新污点的 POD</span></span><br><span class="line">    <span class="string">NoExecute</span>                  <span class="comment"># 新增的污点，影响新的调度过程，且强力驱逐调度已经完成的但不容忍新污点的 POD</span></span><br><span class="line">  <span class="string">key</span>           <span class="string">&lt;string&gt;</span>       <span class="comment"># 键</span></span><br><span class="line">  <span class="string">timeAdded</span>     <span class="string">&lt;string&gt;</span>       <span class="comment"># </span></span><br><span class="line">  <span class="string">value</span>         <span class="string">&lt;string&gt;</span>       <span class="comment"># 值</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看一个 node 节点的污点，custom-columns 根据 go 模板显示一个字段，HAHAHAHA 自定义字段名，–no-headers 不显示字段名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes 172.16.100.101 --no-headers --output=custom-columns=HAHAHAHA:.spec.taints</span><br><span class="line"></span><br><span class="line">kubectl get nodes 172.16.100.11 -o yaml |grep -A 5 taints</span><br></pre></td></tr></table></figure>
<ul>
<li>给 node 打上污点，键为 node-type 值为 production，污点动作</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl taint node node2 node-type=production:NoSchedule</span><br></pre></td></tr></table></figure>
<ul>
<li>删除 node 上的一个污点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl taint node node2 node-type-</span><br></pre></td></tr></table></figure>
<ul>
<li>测试清单</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myapp-deploy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">      release:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">        release:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">ikubernetes/myapp:v2</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果，kubectl get pods -o wide，因为 POD 没有定义容忍 node2 的污点</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">NAME</span>                            <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>            <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-4x5cf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">9</span><span class="string">s</span>    <span class="number">10.244</span><span class="number">.2</span><span class="number">.13</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-58f2s</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">9</span><span class="string">s</span>    <span class="number">10.244</span><span class="number">.2</span><span class="number">.10</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-gz4kv</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">9</span><span class="string">s</span>    <span class="number">10.244</span><span class="number">.2</span><span class="number">.12</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-hlxdd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">9</span><span class="string">s</span>    <span class="number">10.244</span><span class="number">.2</span><span class="number">.11</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>此时给 node3 也打上污点，并驱逐原有的 POD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl taint node node3 node-type=dev:NoExecute</span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果，kubectl get pods -o wide，因为 node3 新增的污点驱逐了不能容忍污点的 POD ，所以 POD 被挂起</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                            READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-deploy-675558bfc5-22wpj   0/1     Pending   0          10s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-675558bfc5-lctv5   0/1     Pending   0          14s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-675558bfc5-m5qdh   0/1     Pending   0          15s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-675558bfc5-z8c4q   0/1     Pending   0          14s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="POD-污点容忍"><a href="#POD-污点容忍" class="headerlink" title="POD 污点容忍"></a>POD 污点容忍</h2><ul>
<li>主节点上的污点</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">taints:</span></span><br><span class="line"><span class="attr">- effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">node-role.kubernetes.io/controlplane</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">- effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">node-role.kubernetes.io/etcd</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>POD 容忍度，详见：kubectl explain pods.spec.tolerations</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">tolerations</span>            <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 容忍度对象</span></span><br><span class="line">  <span class="string">effect</span>               <span class="string">&lt;string&gt;</span>      <span class="comment"># 能否容忍 node 上的污点驱逐策略，为空表示容忍任何驱逐策略</span></span><br><span class="line">    <span class="string">NoSchedule</span>                       <span class="comment"># 能容忍 node 污点的 NoSchedule</span></span><br><span class="line">    <span class="string">PreferNoSchedule</span>                 <span class="comment"># 能容忍 node 污点的 PreferNoSchedule</span></span><br><span class="line">    <span class="string">NoExecute</span>                        <span class="comment"># 能容忍 node 污点的 NoExecute</span></span><br><span class="line">  <span class="string">key</span>                  <span class="string">&lt;string&gt;</span>      <span class="comment"># 污点的键</span></span><br><span class="line">  <span class="string">operator</span>             <span class="string">&lt;string&gt;</span>      <span class="comment"># Exists 污点存在不管什么值，Equal 污点的值必须等值</span></span><br><span class="line">  <span class="string">tolerationSeconds</span>    <span class="string">&lt;integer&gt;</span>     <span class="comment"># 容忍时间，即如果被驱逐，可以等多久再走，默认 0 秒，NoExecute 使用</span></span><br><span class="line">  <span class="string">value</span>                <span class="string">&lt;string&gt;</span>      <span class="comment"># 污点的值</span></span><br></pre></td></tr></table></figure>
<ul>
<li>给 node2 、node3 分别打污点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl taint node node2 node-type=production:NoSchedule</span><br><span class="line">kubectl taint node node3 node-type=dev:NoExecute</span><br></pre></td></tr></table></figure>
<ul>
<li>定义 POD 清单文件，容忍 node 上存在 node-type 值为 dev 的污点、接受被驱逐。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myapp-deploy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">      release:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">        release:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">ikubernetes/myapp:v2</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">node-role.kubernetes.io/etcd</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">node-role.kubernetes.io/controlplane</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果，kubectl get pods -o wide，运行在自己容忍的污点的节点上了</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>            <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">myapp-deploy-97578cf74-5v2r6</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">6</span><span class="string">m22s</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.16</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-97578cf74-gbfj7</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">6</span><span class="string">m22s</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.14</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-97578cf74-l4lbv</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">6</span><span class="string">m22s</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.15</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-97578cf74-zvn8f</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">6</span><span class="string">m20s</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.17</span>   <span class="string">node3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>为节点增加新的污点，设置驱离 POD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl taint node node3 disk=hdd:NoExecute --overwrite</span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果，kubectl get pods -o wide，POD 不能容忍新的污点，结果被驱逐</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-deploy-97578cf74-84bfz   0/1     Pending   0          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-97578cf74-fxk2d   0/1     Pending   0          5s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-97578cf74-jp99j   0/1     Pending   0          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-97578cf74-vdkbx   0/1     Pending   0          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="cordon-停止调度"><a href="#cordon-停止调度" class="headerlink" title="cordon 停止调度"></a>cordon 停止调度</h2><p>cordon 停止调度，这节点不会再被调度新的任务，旧的 POD 不会受到影响</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl cordon node1     <span class="comment"># 标记为不可调度</span></span><br><span class="line">kubectl uncordon node1   <span class="comment"># 标记为可以调度</span></span><br></pre></td></tr></table></figure>
<h2 id="drain-驱逐节点"><a href="#drain-驱逐节点" class="headerlink" title="drain 驱逐节点"></a>drain 驱逐节点</h2><p>drain 维护一个节点，将所有的 POD 驱逐</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl drain node1       <span class="comment"># 标记为不可调度，并且驱逐上面的 POD</span></span><br><span class="line">kubectl drain k8s-master  --delete-local-data --force --ignore-daemonsets</span><br><span class="line"></span><br><span class="line">kubectl uncordon node1    <span class="comment"># 标记为可以调度</span></span><br></pre></td></tr></table></figure>
<h1 id="容器资源限制"><a href="#容器资源限制" class="headerlink" title="容器资源限制"></a>容器资源限制</h1><p>起始值 requests 最低保障</p>
<p>终结值 limits 硬限制</p>
<ul>
<li>CPU</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1 颗 CPU = 1000 millicores</span><br><span class="line">0.5 颗 CPU = 500 m</span><br></pre></td></tr></table></figure>
<ul>
<li>内存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ei、Pi、Ti、Gi、Mi、Ki</span><br></pre></td></tr></table></figure>
<h2 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h2><ul>
<li>清单格式，详见：kubectl explain pods.spec.containers.resources</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">resources</span>      <span class="string">&lt;Object&gt;</span>               <span class="comment"># 资源限制</span></span><br><span class="line">  <span class="string">limits</span>       <span class="string">&lt;map[string]string&gt;</span>    <span class="comment"># 资源最高限制</span></span><br><span class="line">    <span class="string">cpu</span>        <span class="string">&lt;string&gt;</span>               <span class="comment"># 单位 m</span></span><br><span class="line">    <span class="string">memory</span>     <span class="string">&lt;string&gt;</span>               <span class="comment"># 单位 Gi、Mi</span></span><br><span class="line">  <span class="string">requests</span>     <span class="string">&lt;map[string]string&gt;</span>    <span class="comment"># 资源最低要求</span></span><br><span class="line">    <span class="string">cpu</span>        <span class="string">&lt;string&gt;</span>               <span class="comment"># 单位 m</span></span><br><span class="line">    <span class="string">memory</span>     <span class="string">&lt;string&gt;</span>               <span class="comment"># 单位 Gi、Mi</span></span><br></pre></td></tr></table></figure>
<ul>
<li>清单示例，node 节点的 CPU 为 12 核心，cpu limits 设置为 1000m 也就是允许</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-resources-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/stress-ng</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"/usr/bin/stress-ng"</span></span><br><span class="line">    <span class="comment">#- "-m 1"                       # 以单线程压测内存</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"-c 1"</span>                        <span class="comment"># 以单线程压测CPU</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"--metrics-brief"</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">      containerPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">1000</span><span class="string">m</span>                 <span class="comment"># 它决定在预选阶段淘汰哪些主机</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">1000</span><span class="string">m</span>                 <span class="comment"># 表示限制容器使用 node 节点的一颗 CPU，无论多少进程，它们最多只能占用 node 节点的可 CPU</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看结果</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Mem:</span> <span class="number">855392</span><span class="string">K</span> <span class="string">used,</span> <span class="number">139916</span><span class="string">K</span> <span class="string">free,</span> <span class="number">10188</span><span class="string">K</span> <span class="string">shrd,</span> <span class="number">796</span><span class="string">K</span> <span class="string">buff,</span> <span class="number">350368</span><span class="string">K</span> <span class="string">cached</span></span><br><span class="line"><span class="attr">CPU0:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU1:</span> <span class="number">100</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>   <span class="number">0</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span>         <span class="comment"># 占满了一颗 CPU</span></span><br><span class="line"><span class="attr">CPU2:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU3:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU4:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU5:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU6:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU7:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU8:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU9:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU10:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="attr">CPU11:</span>   <span class="number">0</span><span class="string">%</span> <span class="string">usr</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sys</span>   <span class="number">0</span><span class="string">%</span> <span class="string">nic</span>  <span class="number">99</span><span class="string">%</span> <span class="string">idle</span>   <span class="number">0</span><span class="string">%</span> <span class="string">io</span>   <span class="number">0</span><span class="string">%</span> <span class="string">irq</span>   <span class="number">0</span><span class="string">%</span> <span class="string">sirq</span></span><br><span class="line"><span class="string">Load</span> <span class="attr">average:</span> <span class="number">0.84</span> <span class="number">0.50</span> <span class="number">0.40</span> <span class="number">3</span><span class="string">/485</span> <span class="number">11</span></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>     <span class="string">STAT</span>   <span class="string">VSZ</span> <span class="string">%VSZ</span> <span class="string">CPU</span> <span class="string">%CPU</span> <span class="string">COMMAND</span></span><br><span class="line">    <span class="number">6</span>     <span class="number">1</span> <span class="string">root</span>     <span class="string">R</span>     <span class="number">6888</span>   <span class="number">1</span><span class="string">%</span>   <span class="number">1</span>   <span class="number">8</span><span class="string">%</span> <span class="string">&#123;stress-ng-cpu&#125;</span> <span class="string">/usr/bin/stress-ng</span> <span class="bullet">-c</span> <span class="number">1</span> <span class="bullet">--metrics-brief</span></span><br><span class="line">    <span class="number">1</span>     <span class="number">0</span> <span class="string">root</span>     <span class="string">S</span>     <span class="number">6244</span>   <span class="number">1</span><span class="string">%</span>  <span class="number">10</span>   <span class="number">0</span><span class="string">%</span> <span class="string">/usr/bin/stress-ng</span> <span class="bullet">-c</span> <span class="number">1</span> <span class="bullet">--metrics-brief</span></span><br><span class="line">    <span class="number">7</span>     <span class="number">0</span> <span class="string">root</span>     <span class="string">R</span>     <span class="number">1504</span>   <span class="number">0</span><span class="string">%</span>  <span class="number">11</span>   <span class="number">0</span><span class="string">%</span> <span class="string">top</span></span><br></pre></td></tr></table></figure>
<h2 id="qos-质量管理"><a href="#qos-质量管理" class="headerlink" title="qos 质量管理"></a>qos 质量管理</h2><ul>
<li>GuranteedW</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">每个容器同时设置了 CPU 和内存的 requests 和 limits，而且</span><br><span class="line">    cpu.limits = cpu.requests</span><br><span class="line">    memory.limits = memory.requests</span><br><span class="line">那么它将优先被调度</span><br></pre></td></tr></table></figure>
<ul>
<li>Burstable</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">至少有一个容器设置 CPU 或内存资源的 requests 属性</span><br><span class="line"></span><br><span class="line">那么它将具有中等优先级</span><br></pre></td></tr></table></figure>
<ul>
<li>BestEffort</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">没有任何一个容器设置了 requests 或 limits 属性</span><br><span class="line"></span><br><span class="line">那么它将只有最低优先级，当资源不够用的时候，这个容器可能最先被终止，以腾出资源来，为 Burstable 和 Guranteed</span><br></pre></td></tr></table></figure>
<ul>
<li>oom 策略</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">最先杀死占用量和需求量的比例大的</span><br></pre></td></tr></table></figure>
<h1 id="新一代监控架构"><a href="#新一代监控架构" class="headerlink" title="新一代监控架构"></a>新一代监控架构</h1><h2 id="监控对象"><a href="#监控对象" class="headerlink" title="监控对象"></a>监控对象</h2><ul>
<li><p>node_expoerter 节点级别</p>
<p>收集主机的指标数据，如：平均负载、CPU、内存、磁盘、网络等等多个维度的数据。</p>
<p>使用 daemonset 在K8S每个节点上运行一个 POD。</p>
</li>
<li><p>kubelet(cAdivisor)容器级别</p>
</li>
</ul>
<p>（kubelet内置），输出节点级别的核心指标，POD 的核心指标，例如：CPU、内存、限额、文件系统限额、网络报文发送接收速率</p>
<ul>
<li>APIserver</li>
</ul>
<p>通过查询 APIserver 列出每个资源对象，作为监控对象。连入 API server 通过查询来了解有哪些 POD 需要被监控，并且自动把这些 POD 监控起来。是否能被监控取决于是否在 annotations 中定义了相关参数。</p>
<ul>
<li>etcd</li>
</ul>
<p>etcd 集群指标相关数据</p>
<ul>
<li>POD内部 RESTfull 风格接口。</li>
</ul>
<p>或者某些应用的专用接口，例如：mysql_exporter ，prometheus官方有提供这样的监控器</p>
<ul>
<li>kube-state-metrics</li>
</ul>
<p>主要是收集 K8S 工作指标数据的，主要和计数器有关：比如 kube-system 中有多少个 POD 这样的聚合计算，资源计数、资源配额、容器状态等数据，kube-state-metrics 收集完成这些数据然后进行聚合等处理，然后向外输出。</p>
<h2 id="POD定义中"><a href="#POD定义中" class="headerlink" title="POD定义中"></a>POD定义中</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="string">prometheus.io/scrape:</span> <span class="literal">true</span>     <span class="comment"># 允许 prometheus 抓取数据</span></span><br><span class="line">    <span class="string">prometheus.io/path:</span> <span class="string">/metrics</span>   <span class="comment"># 当前 POD 中能够输出指标数据的HTTP地址，默认为 /metrics</span></span><br><span class="line">    <span class="string">prometheus.io/port:</span> <span class="number">80</span> <span class="string">or</span> <span class="number">443</span>  <span class="comment"># 抓取数据时使用的套接字端口</span></span><br></pre></td></tr></table></figure>
<h2 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h2><p>prometheus 是个有状态的应用</p>
<ul>
<li>在 K8S 上的组成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kube-state-metrics:       # 部署为 deployment，收据聚合数据暴露给 prometheus</span><br><span class="line">node_expoerter:           # 部署为 daemonset 用于监控每个节点的节点级数据</span><br><span class="line">Altermanager:             # 部署为 deployment 用于报警</span><br><span class="line">prometheus-server         # 部署为 deployment、seatefullset ，用于收集 node_expoerter 等接口的数据</span><br><span class="line">k8s-prometheus-adapter    # 在 K8S 系统中使用监控数据时候需要将 proQL 数据转换为 K8S 的一个 API</span><br></pre></td></tr></table></figure>
<h2 id="核心指标流水线"><a href="#核心指标流水线" class="headerlink" title="核心指标流水线"></a>核心指标流水线</h2><p>由 kubelet、metrics-server 以及由 apiserver 提供的 api 组成；主要 CPU累计使用率、内存实时使用率、POD 资源占用率及容器的磁盘占用率。</p>
<ul>
<li>metrics-server（新一代的资源指标获取方式）</li>
</ul>
<p>它是一个 apiserver ，它仅仅用于服务于核心指标服务的，它不是 k8s 的组成部分，仅仅是托管在 k8s 之上 POD。</p>
<p>k8s 的 apiserver 和 metrics-server 的 apiserver 前端应该加一个代理服务器，它就是一个聚合器，把来自多个不同的 apiserver 聚合成一个。它就是 kube-aggregator，经过它聚合后的 api 我么将通过 /apis/metrics.k8s.io/v1/beta1 来获取。</p>
<h2 id="监控流水线"><a href="#监控流水线" class="headerlink" title="监控流水线"></a>监控流水线</h2><p>用于从系统收集各种指标数据并提供终端用户、存储系统以及 HPA，它包含核心指标和非核心指标，非核心指标不能被 k8s 所理解，k8s-prometheus-adapter 就是转换为 k8s 所理解格式的一个插件</p>
<ul>
<li>prometheus</li>
</ul>
<p>CNCF下的第二大项目，收集各种维度的指标，它收集的信息，可以来作为是否进行 HPA（自动伸缩） 的一个标准，prometheus 既作为监控系统使用，也作为特殊指标的提供者来使用，但是如果想要作为特殊指标提供给 HPA 这样的机制使用，需要转换格式，而这个转换为特殊指标的一个插件叫：k8s-prometheus-adapter。</p>
<h2 id="安装-metrics-server"><a href="#安装-metrics-server" class="headerlink" title="安装 metrics-server"></a>安装 metrics-server</h2><ul>
<li>官方仓库，这里我使用第一个</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/kubernetes-incubator/metrics-server/tree/master/deploy/1.8%2B      <span class="comment"># 插件官方地址</span></span><br><span class="line">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/metrics-server    <span class="comment"># k8s 官方插件示例</span></span><br></pre></td></tr></table></figure>
<ul>
<li>安装部署相关的文件：/tree/master/deploy/，修改 metrics-server-deployment.yaml 文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">k8s.gcr.io/metrics-server-amd64:v0.3.1</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">  args:</span>                                               <span class="comment"># 添加参数</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'--kubelet-preferred-address-types=InternalIP'</span>    <span class="comment"># 不使用主机名，使用 IP</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'--kubelet-insecure-tls'</span>                          <span class="comment"># 不验证客户端证书</span></span><br><span class="line"><span class="attr">  volumeMounts:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">tmp-dir</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 POD 和 Service 的启动情况</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">$ kubectl get svc -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 API 中是否存在，metrics.k8s.io/v1beta1</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl api-versions</span><br></pre></td></tr></table></figure>
<ul>
<li>通过测试接口获取监控数据，kubectl proxy –port 8080，kubectl top 也可以正常使用了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:8080/apis/metrics.k8s.io/v1beta1</span><br><span class="line">$ kubectl top nodes</span><br></pre></td></tr></table></figure>
<h2 id="安装-prometheus"><a href="#安装-prometheus" class="headerlink" title="安装 prometheus"></a>安装 prometheus</h2><ul>
<li>工作原理</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- prometheus 通过 pull metrilcs 指令从每个 Jobs/exporters 拉取数据</span><br><span class="line">- 其他的 short-lived jobs 也可以通过向 pushgateway 主动发送数据，由 prometheus 被动接收</span><br><span class="line">- prometheus 自身实现了一个时间序列数据库，会将得到的数据存储到其中</span><br><span class="line">- 在 k8s 需要使用 service discovery 来发现服务取得需要监控的目标</span><br><span class="line">- 可以使用 apiclient、webui、Grafana、来将 prometheus 中的数据展示出来</span><br><span class="line">- 当需要报警的时候还会推送给 alertmanager 这个组件由这个组件来发送报警</span><br></pre></td></tr></table></figure>
<ul>
<li>部署文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/prometheus</span><br><span class="line">https://github.com/iKubernetes/k8s-prom</span><br></pre></td></tr></table></figure>
<h2 id="HPA命令行方式"><a href="#HPA命令行方式" class="headerlink" title="HPA命令行方式"></a>HPA命令行方式</h2><ul>
<li>创建 POD 和 service</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=1 --requests=<span class="string">'cpu=50m'</span>,memory=<span class="string">'256Mi'</span> --limits=<span class="string">'cpu=50m,memory=256Mi'</span> --labels=<span class="string">'app=myapp'</span> --expose --port=80</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 HPA 控制器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl autoscale deployment myapp --min=1 --max=8 --cpu-percent=60</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 HPA 控制器，kubectl get hpa</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">myapp   Deployment/myapp   0%/60%    1         8         1          17s</span><br></pre></td></tr></table></figure>
<ul>
<li>开始压力测试</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ab -c 100 -n 5000000 http://172.16.100.102:32749/index.html</span><br></pre></td></tr></table></figure>
<ul>
<li>测试结果，自动扩容生效</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa -w</span><br><span class="line">NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">myapp   Deployment/myapp   0%/60%    1         8         1          7m35s</span><br><span class="line">myapp   Deployment/myapp   34%/60%   1         8         1          9m58s</span><br><span class="line">myapp   Deployment/myapp   102%/60%   1         8         1          11m</span><br><span class="line">myapp   Deployment/myapp   102%/60%   1         8         2          11m</span><br><span class="line">myapp   Deployment/myapp   96%/60%    1         8         2          12m</span><br><span class="line">myapp   Deployment/myapp   96%/60%    1         8         4          12m</span><br><span class="line">myapp   Deployment/myapp   31%/60%    1         8         4          13m</span><br><span class="line">myapp   Deployment/myapp   26%/60%    1         8         4          14m</span><br><span class="line">myapp   Deployment/myapp   0%/60%     1         8         4          15m</span><br><span class="line">myapp   Deployment/myapp   0%/60%     1         8         4          17m</span><br><span class="line">myapp   Deployment/myapp   0%/60%     1         8         3          18m</span><br><span class="line"></span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                     READY   STATUS        RESTARTS   AGE</span><br><span class="line">myapp-64bf6764c5-45qwj   0/1     Terminating   0          7m1s</span><br><span class="line">myapp-64bf6764c5-72crv   1/1     Running       0          20m</span><br><span class="line">myapp-64bf6764c5-gmz6c   1/1     Running       0          8m1s</span><br></pre></td></tr></table></figure>
<h2 id="HPA清单"><a href="#HPA清单" class="headerlink" title="HPA清单"></a>HPA清单</h2><ul>
<li>清单定义详见：kubectl explain hpa.spec</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">maxReplicas</span>                       <span class="string">&lt;integer&gt;</span>         <span class="comment"># 自动伸缩的 POD 数量上限</span></span><br><span class="line"><span class="string">minReplicas</span>                       <span class="string">&lt;integer&gt;</span>         <span class="comment"># 自动伸缩的 POD 数量下限</span></span><br><span class="line"><span class="string">scaleTargetRef</span>	                  <span class="string">&lt;Object&gt;</span>          <span class="comment"># 其他的伸缩指标</span></span><br><span class="line">  <span class="string">apiVersion</span>                      <span class="string">&lt;string&gt;</span>          <span class="comment"># 指标 api 版本</span></span><br><span class="line">  <span class="string">kind</span>                            <span class="string">&lt;string&gt;</span>          <span class="comment"># 指标类型</span></span><br><span class="line">  <span class="string">name</span>                            <span class="string">&lt;string&gt;</span>          <span class="comment"># 可用指标</span></span><br><span class="line"><span class="string">targetCPUUtilizationPercentage</span>    <span class="string">&lt;integer&gt;</span>         <span class="comment"># 根据目标 平均 CPU 利用率阈值评估自动伸缩</span></span><br></pre></td></tr></table></figure>
<ul>
<li>示例清单，它实现了对 myapp 这个 deployment 控制器下的 POD 进行自动扩容</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myapp-hpa-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  scaleTargetRef:</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">  minReplicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  maxReplicas:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  metrics:</span></span><br><span class="line"><span class="attr">  - type:</span> <span class="string">Resource</span></span><br><span class="line"><span class="attr">    resource:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">cpu</span></span><br><span class="line"><span class="attr">      targetAverageUtilization:</span> <span class="number">55</span></span><br><span class="line"><span class="attr">  - type:</span> <span class="string">Resource</span></span><br><span class="line"><span class="attr">    resource:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">memory</span></span><br><span class="line"><span class="attr">      targetAverageValue:</span> <span class="number">50</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure>
<h1 id="K8S包管理器"><a href="#K8S包管理器" class="headerlink" title="K8S包管理器"></a>K8S包管理器</h1><p>Helm 是 Deis 开发的一个用于 Kubernetes 应用的包管理工具，主要用来管理 Charts。有点类似于 Ubuntu 中的 APT 或 CentOS 中的 YUM。</p>
<p>Helm Chart 是用来封装 Kubernetes 原生应用程序的一系列 YAML 文件。可以在你部署应用的时候自定义应用程序的一些 Metadata，以便于应用程序的分发。</p>
<p>对于应用发布者而言，可以通过 Helm 打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。</p>
<p>对于使用者而言，使用 Helm 后不用需要编写复杂的应用部署文件，可以以简单的方式在 Kubernetes 上查找、安装、升级、回滚、卸载应用程序。</p>
<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><ul>
<li>Helm</li>
</ul>
<p>Helm 是一个命令行下的客户端工具。主要用于 Kubernetes 应用程序 Chart 的创建、打包、发布以及创建和管理本地和远程的 Chart 仓库。</p>
<ul>
<li>Tiller</li>
</ul>
<p>Tiller 是 Helm 的服务端，部署在 Kubernetes 集群中。Tiller 用于接收 Helm 的请求，并根据 Chart 生成 Kubernetes 的部署文件（Helm 称为 Release），然后提交给 Kubernetes 创建应用。Tiller 还提供了 Release 的升级、删除、回滚等一系列功能。</p>
<ul>
<li>Chart</li>
</ul>
<p>Helm 的软件包，采用 TAR 格式。类似于 APT 的 DEB 包或者 YUM 的 RPM 包，其包含了一组定义 Kubernetes 资源相关的 YAML 文件。</p>
<ul>
<li>Repoistory</li>
</ul>
<p>Helm 的软件仓库，Repository 本质上是一个 Web 服务器，该服务器保存了一系列的 Chart 软件包以供用户下载，并且提供了一个该 Repository 的 Chart 包的清单文件以供查询，Helm 可以同时管理多个不同的 Repository。</p>
<ul>
<li>Release</li>
</ul>
<p>使用 helm install 命令在 Kubernetes 集群中部署的 Chart 称为 Release。Chart 与 Release 的关系类似于面向对象中的类与实例的关系。</p>
<h2 id="部署-Helm"><a href="#部署-Helm" class="headerlink" title="部署 Helm"></a>部署 Helm</h2><ul>
<li>下载解压，设置执行权限，官方下载地址：<a href="https://github.com/helm/helm/releases/tag/v2.14.1" target="_blank" rel="noopener">https://github.com/helm/helm/releases/tag/v2.14.1</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget https://storage.googleapis.com/kubernetes-helm/helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">$ tar xf helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">$ mv helm /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure>
<ul>
<li>配置 tiller 的 rbac 权限，官方页面：<a href="https://github.com/helm/helm/blob/master/docs/rbac.md" target="_blank" rel="noopener">https://github.com/helm/helm/blob/master/docs/rbac.md</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f rbac-config.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化 helm 会连接 K8S 集群并部署 tiller，所以应该确保 ~/.kube 目录的 config 正确性，helm 会读取它</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.14.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>
<ul>
<li>添加 incubator 源</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm repo add incubator https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/</span><br><span class="line">$ helm repo update</span><br></pre></td></tr></table></figure>
<ul>
<li>安装完成，查看版本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm version</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Helm-工作原理"><a href="#Helm-工作原理" class="headerlink" title="Helm 工作原理"></a>Helm 工作原理</h2><ul>
<li>Chart Install 过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Helm 从指定的目录或者 TAR 文件中解析出 Chart 结构信息。</span><br><span class="line">2. Helm 将指定的 Chart 结构和 Values 信息通过 gRPC 传递给 Tiller。</span><br><span class="line">3. Tiller 根据 Chart 和 Values 生成一个 Release。</span><br><span class="line">4. Tiller 将 Release 发送给 Kubernetes 用于生成 Release。</span><br></pre></td></tr></table></figure>
<ul>
<li>Chart Update 过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Helm 从指定的目录或者 TAR 文件中解析出 Chart 结构信息。</span><br><span class="line">2. Helm 将需要更新的 Release 的名称、Chart 结构和 Values 信息传递给 Tiller。</span><br><span class="line">3. Tiller 生成 Release 并更新指定名称的 Release 的 History。</span><br><span class="line">4. Tiller 将 Release 发送给 Kubernetes 用于更新 Release。</span><br></pre></td></tr></table></figure>
<ul>
<li>Chart Rollback 过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Helm 将要回滚的 Release 的名称传递给 Tiller。</span><br><span class="line">2. Tiller 根据 Release 的名称查找 History。</span><br><span class="line">3. Tiller 从 History 中获取上一个 Release。</span><br><span class="line">4. Tiller 将上一个 Release 发送给 Kubernetes 用于替换当前 Release。</span><br></pre></td></tr></table></figure>
<ul>
<li>Chart 处理依赖说明</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Tiller 在处理 Chart 时，直接将 Chart 以及其依赖的所有 Charts 合并为一个 Release，同时传递给 Kubernetes。</span><br><span class="line">因此 Tiller 并不负责管理依赖之间的启动顺序。Chart 中的应用需要能够自行处理依赖关系。</span><br></pre></td></tr></table></figure>
<h2 id="Helm-命令用法"><a href="#Helm-命令用法" class="headerlink" title="Helm 命令用法"></a>Helm 命令用法</h2><ul>
<li>helm 官方可用的 chart 仓库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://hub.kubeapps.com/</span><br></pre></td></tr></table></figure>
<ul>
<li>命令基本使用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">completion 	<span class="comment"># 为指定的shell生成自动完成脚本（bash或zsh）</span></span><br><span class="line">create     	<span class="comment"># 创建一个具有给定名称的新 chart</span></span><br><span class="line">delete     	<span class="comment"># 从 Kubernetes 删除指定名称的 release</span></span><br><span class="line">dependency 	<span class="comment"># 管理 chart 的依赖关系</span></span><br><span class="line">fetch      	<span class="comment"># 从存储库下载 chart 并（可选）将其解压缩到本地目录中</span></span><br><span class="line">get        	<span class="comment"># 下载一个命名 release</span></span><br><span class="line"><span class="built_in">help</span>       	<span class="comment"># 列出所有帮助信息</span></span><br><span class="line"><span class="built_in">history</span>    	<span class="comment"># 获取 release 历史</span></span><br><span class="line">home       	<span class="comment"># 显示 HELM_HOME 的位置</span></span><br><span class="line">init       	<span class="comment"># 在客户端和服务器上初始化Helm</span></span><br><span class="line">inspect    	<span class="comment"># 检查 chart 详细信息</span></span><br><span class="line">install    	<span class="comment"># 安装 chart 存档</span></span><br><span class="line">lint       	<span class="comment"># 对 chart 进行语法检查</span></span><br><span class="line">list       	<span class="comment"># releases 列表</span></span><br><span class="line">package    	<span class="comment"># 将 chart 目录打包成 chart 档案</span></span><br><span class="line">plugin     	<span class="comment"># 添加列表或删除 helm 插件</span></span><br><span class="line">repo       	<span class="comment"># 添加列表删除更新和索引 chart 存储库</span></span><br><span class="line">reset      	<span class="comment"># 从集群中卸载 Tiller</span></span><br><span class="line">rollback   	<span class="comment"># 将版本回滚到以前的版本</span></span><br><span class="line">search     	<span class="comment"># 在 chart 存储库中搜索关键字</span></span><br><span class="line">serve      	<span class="comment"># 启动本地http网络服务器</span></span><br><span class="line">status     	<span class="comment"># 显示指定 release 的状态</span></span><br><span class="line">template   	<span class="comment"># 本地渲染模板</span></span><br><span class="line"><span class="built_in">test</span>       	<span class="comment"># 测试一个 release</span></span><br><span class="line">upgrade    	<span class="comment"># 升级一个 release</span></span><br><span class="line">verify     	<span class="comment"># 验证给定路径上的 chart 是否已签名且有效</span></span><br><span class="line">version    	<span class="comment"># 打印客户端/服务器版本信息</span></span><br><span class="line">dep         <span class="comment"># 分析 Chart 并下载依赖</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打包一个 chart</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm package ./</span><br></pre></td></tr></table></figure>
<ul>
<li>指定 values.yaml 部署一个 chart</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install --name els1 -f values.yaml stable/elasticsearch</span><br></pre></td></tr></table></figure>
<ul>
<li>升级一个 chart</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm upgrade --<span class="built_in">set</span> mysqlRootPassword=passwd db-mysql stable/mysql</span><br></pre></td></tr></table></figure>
<ul>
<li>回滚一个 chart</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm rollback db-mysql 1</span><br></pre></td></tr></table></figure>
<ul>
<li>删除一个 release</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm delete --purge db-mysql</span><br></pre></td></tr></table></figure>
<ul>
<li>只对模板进行渲染然后输出，不进行安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install/upgrade xxx --dry-run --debug</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 chart 依赖并下载</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm dep up ./</span><br></pre></td></tr></table></figure>
<h2 id="Chart文件组织"><a href="#Chart文件组织" class="headerlink" title="Chart文件组织"></a>Chart文件组织</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">myapp/                               <span class="comment"># Chart 目录</span></span><br><span class="line">├── charts                           <span class="comment"># 这个 charts 依赖的其他 charts，始终被安装</span></span><br><span class="line">├── Chart.yaml                       <span class="comment"># 描述这个 Chart 的相关信息、包括名字、描述信息、版本等</span></span><br><span class="line">├── templates                        <span class="comment"># 模板目录</span></span><br><span class="line">│   ├── deployment.yaml              <span class="comment"># deployment 控制器的 Go 模板文件</span></span><br><span class="line">│   ├── _helpers.tpl                 <span class="comment"># 以 _ 开头的文件不会部署到 k8s 上，可用于定制通用信息</span></span><br><span class="line">│   ├── ingress.yaml                 <span class="comment"># ingress 的模板文件</span></span><br><span class="line">│   ├── NOTES.txt                    <span class="comment"># Chart 部署到集群后的一些信息，例如：如何使用、列出缺省值</span></span><br><span class="line">│   ├── service.yaml                 <span class="comment"># service 的 Go 模板文件</span></span><br><span class="line">│   └── tests</span><br><span class="line">│       └── <span class="built_in">test</span>-connection.yaml</span><br><span class="line">└── values.yaml                      <span class="comment"># 模板的值文件，这些值会在安装时应用到 GO 模板生成部署文件</span></span><br></pre></td></tr></table></figure>
<h2 id="使用-Helm-Ceph-部署-EFK"><a href="#使用-Helm-Ceph-部署-EFK" class="headerlink" title="使用 Helm + Ceph 部署 EFK"></a>使用 Helm + Ceph 部署 EFK</h2><p>本文使用 K8S 集群上运行 EFK，使用 Ceph 集群作为 ElasticSearch 集群的持久存储。</p>
<p>用到知识有：Storage Class、PVC、Helm，另外，很多服务镜像需要翻墙。</p>
<p>helm install 阻塞过程会下载镜像可能会比较慢。</p>
<p>helm 里面有很多可以定制的项目，这里我就不定制了，反正我的资源也够用，懒得调了。</p>
<p>感觉没啥可以写的 😂</p>
<h2 id="Storage-Class"><a href="#Storage-Class" class="headerlink" title="Storage Class"></a>Storage Class</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ceph-admin-secret</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">"kubernetes.io/rbd"</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># ceph auth get-key client.admin | base64</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">QVFER3U5TmMQNXQ4SlJBAAhHMGltdXZlNFZkUXAvN2tTZ1BENGc9PQ==</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ceph-secret</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">"kubernetes.io/rbd"</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># ceph auth get-key client.kube | base64</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">QVFCcUM5VmNWVDdQCCCCWR1NUxFNfVKeTAiazdUWVhOa3N2UWc9PQ==</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ceph-rbd</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">ceph.com/rbd</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  monitors:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.9</span><span class="string">:6789</span></span><br><span class="line"><span class="attr">  pool:</span> <span class="string">kube</span></span><br><span class="line"><span class="attr">  adminId:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  adminSecretName:</span> <span class="string">ceph-admin-secret</span></span><br><span class="line"><span class="attr">  adminSecretNamespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  userId:</span> <span class="string">kube</span></span><br><span class="line"><span class="attr">  userSecretName:</span> <span class="string">ceph-secret</span></span><br><span class="line"><span class="attr">  userSecretNamespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  fsType:</span> <span class="string">ext4</span></span><br><span class="line"><span class="attr">  imageFormat:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">  imageFeatures:</span> <span class="string">"layering"</span></span><br></pre></td></tr></table></figure>
<h2 id="Helm-Elasticsearch"><a href="#Helm-Elasticsearch" class="headerlink" title="Helm Elasticsearch"></a>Helm Elasticsearch</h2><ul>
<li>下载 elasticsearch 的 StatfullSet 的 chart</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm fetch stable/elasticsearch</span><br></pre></td></tr></table></figure>
<ul>
<li>编辑 values.yaml，修改 storageClass 指向上面创建的 storageClass</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">storageClass:</span> <span class="string">"ceph-rbd"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 helm 指定 values.yaml 部署 elasticsearch</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install --name els1 -f values.yaml stable/elasticsearch</span><br></pre></td></tr></table></figure>
<ul>
<li>安装后查看，调试直到全部处于 READY 状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">els1-elasticsearch-client-55696f5bdd-qczbf   1/1     Running   1          78m</span><br><span class="line">els1-elasticsearch-client-55696f5bdd-tdwdc   1/1     Running   1          78m</span><br><span class="line">els1-elasticsearch-data-0                    1/1     Running   1          78m</span><br><span class="line">els1-elasticsearch-data-1                    1/1     Running   1          56m</span><br><span class="line">els1-elasticsearch-master-0                  1/1     Running   1          78m</span><br><span class="line">els1-elasticsearch-master-1                  1/1     Running   1          53m</span><br><span class="line">els1-elasticsearch-master-2                  1/1     Running   1          52m</span><br><span class="line">rbd-provisioner-9b8ffbcc-nxdjd               1/1     Running   2          81m</span><br></pre></td></tr></table></figure>
<ul>
<li>也可以使用 helm 命令查看</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm status els1</span><br><span class="line"></span><br><span class="line">LAST DEPLOYED: Sun May 12 16:28:56 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                     DATA  AGE</span><br><span class="line">els1-elasticsearch       4     88m</span><br><span class="line">els1-elasticsearch-test  1     88m</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                        READY  STATUS   RESTARTS  AGE</span><br><span class="line">els1-elasticsearch-client-55696f5bdd-qczbf  1/1    Running  1         88m</span><br><span class="line">els1-elasticsearch-client-55696f5bdd-tdwdc  1/1    Running  1         88m</span><br><span class="line">els1-elasticsearch-data-0                   1/1    Running  1         88m</span><br><span class="line">els1-elasticsearch-data-1                   1/1    Running  1         66m</span><br><span class="line">els1-elasticsearch-master-0                 1/1    Running  1         88m</span><br><span class="line">els1-elasticsearch-master-1                 1/1    Running  1         63m</span><br><span class="line">els1-elasticsearch-master-2                 1/1    Running  1         62m</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)   AGE</span><br><span class="line">els1-elasticsearch-client     ClusterIP  10.98.197.185  &lt;none&gt;       9200/TCP  88m</span><br><span class="line">els1-elasticsearch-discovery  ClusterIP  None           &lt;none&gt;       9300/TCP  88m</span><br><span class="line"></span><br><span class="line">==&gt; v1/ServiceAccount</span><br><span class="line">NAME                       SECRETS  AGE</span><br><span class="line">els1-elasticsearch-client  1        88m</span><br><span class="line">els1-elasticsearch-data    1        88m</span><br><span class="line">els1-elasticsearch-master  1        88m</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/Deployment</span><br><span class="line">NAME                       READY  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">els1-elasticsearch-client  2/2    2           2          88m</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/StatefulSet</span><br><span class="line">NAME                       READY  AGE</span><br><span class="line">els1-elasticsearch-data    2/2    88m</span><br><span class="line">els1-elasticsearch-master  3/3    88m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">The elasticsearch cluster has been installed.</span><br><span class="line"></span><br><span class="line">Elasticsearch can be accessed:</span><br><span class="line"></span><br><span class="line">  * Within your cluster, at the following DNS name at port 9200:</span><br><span class="line"></span><br><span class="line">    els1-elasticsearch-client.default.svc</span><br><span class="line"></span><br><span class="line">  * From outside the cluster, run these commands <span class="keyword">in</span> the same shell:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=elasticsearch,component=client,release=els1"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Visit http://127.0.0.1:9200 to use Elasticsearch"</span></span><br><span class="line">    kubectl port-forward --namespace default <span class="variable">$POD_NAME</span> 9200:9200</span><br></pre></td></tr></table></figure>
<ul>
<li>启动一个临时的容器，解析集群地址，测试集群信息，查看集群节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run cirros1 --rm -it --image=cirros -- /bin/sh</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup els1-elasticsearch-client.default.svc</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      els1-elasticsearch-client.default.svc</span><br><span class="line">Address 1: 10.98.197.185 els1-elasticsearch-client.default.svc.cluster.local</span><br><span class="line">/ <span class="comment"># curl els1-elasticsearch-client.default.svc.cluster.local:9200/_cat/nodes</span></span><br><span class="line">10.244.2.28  7 96 2 0.85 0.26 0.16 di - els1-elasticsearch-data-0</span><br><span class="line">10.244.1.37  7 83 1 0.04 0.06 0.11 di - els1-elasticsearch-data-1</span><br><span class="line">10.244.2.25 19 96 2 0.85 0.26 0.16 i  - els1-elasticsearch-client-55696f5bdd-tdwdc</span><br><span class="line">10.244.2.27 28 96 2 0.85 0.26 0.16 mi * els1-elasticsearch-master-2</span><br><span class="line">10.244.1.39 19 83 1 0.04 0.06 0.11 i  - els1-elasticsearch-client-55696f5bdd-qczbf</span><br><span class="line">10.244.2.29 21 96 2 0.85 0.26 0.16 mi - els1-elasticsearch-master-1</span><br><span class="line">10.244.1.38 23 83 1 0.04 0.06 0.11 mi - els1-elasticsearch-master-0</span><br></pre></td></tr></table></figure>
<h2 id="Helm-fluentd-elasticsearch"><a href="#Helm-fluentd-elasticsearch" class="headerlink" title="Helm fluentd-elasticsearch"></a>Helm fluentd-elasticsearch</h2><ul>
<li>安装 kiwigrid 源</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm repo add kiwigrid https://kiwigrid.github.io</span><br></pre></td></tr></table></figure>
<ul>
<li>下载 fluentd-elasticsearch</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm fetch kiwigrid/fluentd-elasticsearch</span><br></pre></td></tr></table></figure>
<ul>
<li>获取集群地址</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">els1-elasticsearch-client.default.svc.cluster.local:9200</span><br></pre></td></tr></table></figure>
<ul>
<li>编辑修改 values.yaml，指定 elasticsearch 集群的位置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">elasticsearch:</span><br><span class="line">  host: <span class="string">'els1-elasticsearch-client.default.svc.cluster.local'</span></span><br><span class="line">  port: 9200</span><br></pre></td></tr></table></figure>
<ul>
<li>修改对污点的容忍程度，使其容忍 Master 节点的污点，也运行在 Master 节点上收集信息</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tolerations:</span> </span><br><span class="line"><span class="attr">  - key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">    operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">    effect:</span> <span class="string">NoSchedule</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果使用 prometheus 监控应该打开 prometheusRole 规则</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">podAnnotations:</span></span><br><span class="line">  <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="string">prometheus.io/port:</span> <span class="string">"24231"</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">service:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">"monitor-agent"</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">24231</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 helm 指定 values.yaml 部署 fluentd-elasticsearch</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install --name flu1 -f values.yaml kiwigrid/fluentd-elasticsearch</span><br></pre></td></tr></table></figure>
<ul>
<li>查看状态 flu1 这个 helm 服务的运行状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master fluentd-elasticsearch]<span class="comment"># helm status flu1</span></span><br><span class="line">LAST DEPLOYED: Sun May 12 18:13:12 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ClusterRole</span><br><span class="line">NAME                        AGE</span><br><span class="line">flu1-fluentd-elasticsearch  17m</span><br><span class="line"></span><br><span class="line">==&gt; v1/ClusterRoleBinding</span><br><span class="line">NAME                        AGE</span><br><span class="line">flu1-fluentd-elasticsearch  17m</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                        DATA  AGE</span><br><span class="line">flu1-fluentd-elasticsearch  6     17m</span><br><span class="line"></span><br><span class="line">==&gt; v1/DaemonSet</span><br><span class="line">NAME                        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE  NODE SELECTOR  AGE</span><br><span class="line">flu1-fluentd-elasticsearch  3        3        3      3           3          &lt;none&gt;         17m</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                              READY  STATUS   RESTARTS  AGE</span><br><span class="line">flu1-fluentd-elasticsearch-p49fc  1/1    Running  1         17m</span><br><span class="line">flu1-fluentd-elasticsearch-q5b9k  1/1    Running  0         17m</span><br><span class="line">flu1-fluentd-elasticsearch-swfvt  1/1    Running  0         17m</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                        TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)    AGE</span><br><span class="line">flu1-fluentd-elasticsearch  ClusterIP  10.106.106.209  &lt;none&gt;       24231/TCP  17m</span><br><span class="line"></span><br><span class="line">==&gt; v1/ServiceAccount</span><br><span class="line">NAME                        SECRETS  AGE</span><br><span class="line">flu1-fluentd-elasticsearch  1        17m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">1. To verify that Fluentd has started, run:</span><br><span class="line"></span><br><span class="line">  kubectl --namespace=default get pods -l <span class="string">"app.kubernetes.io/name=fluentd-elasticsearch,app.kubernetes.io/instance=flu1"</span></span><br><span class="line"></span><br><span class="line">THIS APPLICATION CAPTURES ALL CONSOLE OUTPUT AND FORWARDS IT TO elasticsearch . Anything that might be identifying,</span><br><span class="line">including things like IP addresses, container images, and object names will NOT be anonymized.</span><br><span class="line">2. Get the application URL by running these commands:</span><br><span class="line">  <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=fluentd-elasticsearch,app.kubernetes.io/instance=flu1"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">  kubectl port-forward <span class="variable">$POD_NAME</span> 8080:80</span><br></pre></td></tr></table></figure>
<ul>
<li>是否生成了索引，直接使用访问 elasticsearch 的 RESTfull API 接口。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run cirros1 --rm -it --image=cirros -- /bin/sh</span><br><span class="line">/ <span class="comment"># curl els1-elasticsearch-client.default.svc.cluster.local:9200/_cat/indices</span></span><br><span class="line">green open logstash-2019.05.10 a2b-GyKsSLOZPqGKbCpyJw 5 1   158 0 84.2kb   460b</span><br><span class="line">green open logstash-2019.05.09 CwYylNhdRf-A5UELhrzHow 5 1 71418 0 34.3mb 17.4mb</span><br><span class="line">green open logstash-2019.05.12 5qRFpV46RGG_bWC4xbsyVA 5 1 34496 0 26.1mb 13.2mb</span><br></pre></td></tr></table></figure>
<h2 id="Helm-kibana"><a href="#Helm-kibana" class="headerlink" title="Helm kibana"></a>Helm kibana</h2><ul>
<li>下载 stable/kibana</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm fetch stable/kibana</span><br></pre></td></tr></table></figure>
<ul>
<li>编辑 values.yaml，修改 elasticsearch 指向 elasticsearch 集群的地址</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">elasticsearch.hosts: http://els1-elasticsearch-client.default.svc.cluster.local:920</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 service 的工作模式，使得可以从集群外部访问</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">service:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 helm 指定 values.yaml 部署 kibana</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install --name kib1 -f values.yaml stable/kibana</span><br></pre></td></tr></table></figure>
<ul>
<li>获取 service 端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc</span><br><span class="line">NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">els1-elasticsearch-client      ClusterIP   10.98.197.185   &lt;none&gt;        9200/TCP        4h51m</span><br><span class="line">els1-elasticsearch-discovery   ClusterIP   None            &lt;none&gt;        9300/TCP        4h51m</span><br><span class="line">flu1-fluentd-elasticsearch     ClusterIP   10.101.97.11    &lt;none&gt;        24231/TCP       157m</span><br><span class="line">kib1-kibana                    NodePort    10.103.7.215    &lt;none&gt;        443:31537/TCP   6m50s</span><br><span class="line">kubernetes                     ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         3d4h</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 service 工作在 NodePort 模式下，所以可以在集群外部访问了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">172.16.100.6:31537</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/38/">38</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Jin Heng">
            
              <p class="site-author-name" itemprop="name">Jin Heng</p>
              <p class="site-description motion-element" itemprop="description">越努力越幸运</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yangjinheng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jinhengyang@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          
        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jin Heng</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  





  

  

  

  
  

  

  

  

</body>
</html>
